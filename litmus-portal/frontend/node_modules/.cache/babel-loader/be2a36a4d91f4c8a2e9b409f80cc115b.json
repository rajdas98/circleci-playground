{"ast":null,"code":"/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar d3 = require('d3');\n\nvar Lib = require('../../lib');\n\nvar Plots = require('../../plots/plots');\n\nvar Registry = require('../../registry');\n\nvar Events = require('../../lib/events');\n\nvar dragElement = require('../dragelement');\n\nvar Drawing = require('../drawing');\n\nvar Color = require('../color');\n\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar handleClick = require('./handle_click');\n\nvar constants = require('./constants');\n\nvar alignmentConstants = require('../../constants/alignment');\n\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar FROM_TL = alignmentConstants.FROM_TL;\nvar FROM_BR = alignmentConstants.FROM_BR;\n\nvar getLegendData = require('./get_legend_data');\n\nvar style = require('./style');\n\nvar helpers = require('./helpers');\n\nmodule.exports = function draw(gd, opts) {\n  var fullLayout = gd._fullLayout;\n  var clipId = 'legend' + fullLayout._uid;\n  var layer; // Check whether this is the main legend (ie. called without any opts)\n\n  if (!opts) {\n    opts = fullLayout.legend || {};\n    opts._main = true;\n    layer = fullLayout._infolayer;\n  } else {\n    layer = opts.layer;\n    clipId += '-hover';\n  }\n\n  if (!layer) return;\n  if (!gd._legendMouseDownTime) gd._legendMouseDownTime = 0;\n  var legendData;\n\n  if (opts._main) {\n    if (!gd.calcdata) return;\n    legendData = fullLayout.showlegend && getLegendData(gd.calcdata, opts);\n  } else {\n    if (!opts.entries) return;\n    legendData = getLegendData(opts.entries, opts);\n  }\n\n  var hiddenSlices = fullLayout.hiddenlabels || [];\n\n  if (opts._main && (!fullLayout.showlegend || !legendData.length)) {\n    layer.selectAll('.legend').remove();\n\n    fullLayout._topdefs.select('#' + clipId).remove();\n\n    return Plots.autoMargin(gd, 'legend');\n  }\n\n  var legend = Lib.ensureSingle(layer, 'g', 'legend', function (s) {\n    if (opts._main) s.attr('pointer-events', 'all');\n  });\n  var clipPath = Lib.ensureSingleById(fullLayout._topdefs, 'clipPath', clipId, function (s) {\n    s.append('rect');\n  });\n  var bg = Lib.ensureSingle(legend, 'rect', 'bg', function (s) {\n    s.attr('shape-rendering', 'crispEdges');\n  });\n  bg.call(Color.stroke, opts.bordercolor).call(Color.fill, opts.bgcolor).style('stroke-width', opts.borderwidth + 'px');\n  var scrollBox = Lib.ensureSingle(legend, 'g', 'scrollbox');\n  var title = opts.title;\n  opts._titleWidth = 0;\n  opts._titleHeight = 0;\n\n  if (title.text) {\n    var titleEl = Lib.ensureSingle(scrollBox, 'text', 'legendtitletext');\n    titleEl.attr('text-anchor', 'start').classed('user-select-none', true).call(Drawing.font, title.font).text(title.text);\n    textLayout(titleEl, scrollBox, gd, opts); // handle mathjax or multi-line text and compute title height\n  } else {\n    scrollBox.selectAll('.legendtitletext').remove();\n  }\n\n  var scrollBar = Lib.ensureSingle(legend, 'rect', 'scrollbar', function (s) {\n    s.attr(constants.scrollBarEnterAttrs).call(Color.fill, constants.scrollBarColor);\n  });\n  var groups = scrollBox.selectAll('g.groups').data(legendData);\n  groups.enter().append('g').attr('class', 'groups');\n  groups.exit().remove();\n  var traces = groups.selectAll('g.traces').data(Lib.identity);\n  traces.enter().append('g').attr('class', 'traces');\n  traces.exit().remove();\n  traces.style('opacity', function (d) {\n    var trace = d[0].trace;\n\n    if (Registry.traceIs(trace, 'pie-like')) {\n      return hiddenSlices.indexOf(d[0].label) !== -1 ? 0.5 : 1;\n    } else {\n      return trace.visible === 'legendonly' ? 0.5 : 1;\n    }\n  }).each(function () {\n    d3.select(this).call(drawTexts, gd, opts);\n  }).call(style, gd, opts).each(function () {\n    if (opts._main) d3.select(this).call(setupTraceToggle, gd);\n  });\n  Lib.syncOrAsync([Plots.previousPromises, function () {\n    return computeLegendDimensions(gd, groups, traces, opts);\n  }, function () {\n    // IF expandMargin return a Promise (which is truthy),\n    // we're under a doAutoMargin redraw, so we don't have to\n    // draw the remaining pieces below\n    if (opts._main && expandMargin(gd)) return;\n    var gs = fullLayout._size;\n    var bw = opts.borderwidth;\n\n    var lx = gs.l + gs.w * opts.x - FROM_TL[getXanchor(opts)] * opts._width;\n\n    var ly = gs.t + gs.h * (1 - opts.y) - FROM_TL[getYanchor(opts)] * opts._effHeight;\n\n    if (opts._main && fullLayout.margin.autoexpand) {\n      var lx0 = lx;\n      var ly0 = ly;\n      lx = Lib.constrain(lx, 0, fullLayout.width - opts._width);\n      ly = Lib.constrain(ly, 0, fullLayout.height - opts._effHeight);\n\n      if (lx !== lx0) {\n        Lib.log('Constrain legend.x to make legend fit inside graph');\n      }\n\n      if (ly !== ly0) {\n        Lib.log('Constrain legend.y to make legend fit inside graph');\n      }\n    } // Set size and position of all the elements that make up a legend:\n    // legend, background and border, scroll box and scroll bar as well as title\n\n\n    if (opts._main) Drawing.setTranslate(legend, lx, ly); // to be safe, remove previous listeners\n\n    scrollBar.on('.drag', null);\n    legend.on('wheel', null);\n\n    if (!opts._main || opts._height <= opts._maxHeight || gd._context.staticPlot) {\n      // if scrollbar should not be shown.\n      var height = opts._effHeight; // if not the main legend, let it be its full size\n\n      if (!opts._main) height = opts._height;\n      bg.attr({\n        width: opts._width - bw,\n        height: height - bw,\n        x: bw / 2,\n        y: bw / 2\n      });\n      Drawing.setTranslate(scrollBox, 0, 0);\n      clipPath.select('rect').attr({\n        width: opts._width - 2 * bw,\n        height: height - 2 * bw,\n        x: bw,\n        y: bw\n      });\n      Drawing.setClipUrl(scrollBox, clipId, gd);\n      Drawing.setRect(scrollBar, 0, 0, 0, 0);\n      delete opts._scrollY;\n    } else {\n      var scrollBarHeight = Math.max(constants.scrollBarMinHeight, opts._effHeight * opts._effHeight / opts._height);\n      var scrollBarYMax = opts._effHeight - scrollBarHeight - 2 * constants.scrollBarMargin;\n      var scrollBoxYMax = opts._height - opts._effHeight;\n      var scrollRatio = scrollBarYMax / scrollBoxYMax;\n      var scrollBoxY = Math.min(opts._scrollY || 0, scrollBoxYMax); // increase the background and clip-path width\n      // by the scrollbar width and margin\n\n      bg.attr({\n        width: opts._width - 2 * bw + constants.scrollBarWidth + constants.scrollBarMargin,\n        height: opts._effHeight - bw,\n        x: bw / 2,\n        y: bw / 2\n      });\n      clipPath.select('rect').attr({\n        width: opts._width - 2 * bw + constants.scrollBarWidth + constants.scrollBarMargin,\n        height: opts._effHeight - 2 * bw,\n        x: bw,\n        y: bw + scrollBoxY\n      });\n      Drawing.setClipUrl(scrollBox, clipId, gd);\n      scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio); // scroll legend by mousewheel or touchpad swipe up/down\n\n      legend.on('wheel', function () {\n        scrollBoxY = Lib.constrain(opts._scrollY + d3.event.deltaY / scrollBarYMax * scrollBoxYMax, 0, scrollBoxYMax);\n        scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n\n        if (scrollBoxY !== 0 && scrollBoxY !== scrollBoxYMax) {\n          d3.event.preventDefault();\n        }\n      });\n      var eventY0, eventY1, scrollBoxY0;\n\n      var getScrollBarDragY = function getScrollBarDragY(scrollBoxY0, eventY0, eventY1) {\n        var y = (eventY1 - eventY0) / scrollRatio + scrollBoxY0;\n        return Lib.constrain(y, 0, scrollBoxYMax);\n      };\n\n      var getNaturalDragY = function getNaturalDragY(scrollBoxY0, eventY0, eventY1) {\n        var y = (eventY0 - eventY1) / scrollRatio + scrollBoxY0;\n        return Lib.constrain(y, 0, scrollBoxYMax);\n      }; // scroll legend by dragging scrollBAR\n\n\n      var scrollBarDrag = d3.behavior.drag().on('dragstart', function () {\n        var e = d3.event.sourceEvent;\n\n        if (e.type === 'touchstart') {\n          eventY0 = e.changedTouches[0].clientY;\n        } else {\n          eventY0 = e.clientY;\n        }\n\n        scrollBoxY0 = scrollBoxY;\n      }).on('drag', function () {\n        var e = d3.event.sourceEvent;\n        if (e.buttons === 2 || e.ctrlKey) return;\n\n        if (e.type === 'touchmove') {\n          eventY1 = e.changedTouches[0].clientY;\n        } else {\n          eventY1 = e.clientY;\n        }\n\n        scrollBoxY = getScrollBarDragY(scrollBoxY0, eventY0, eventY1);\n        scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n      });\n      scrollBar.call(scrollBarDrag); // scroll legend by touch-dragging scrollBOX\n\n      var scrollBoxTouchDrag = d3.behavior.drag().on('dragstart', function () {\n        var e = d3.event.sourceEvent;\n\n        if (e.type === 'touchstart') {\n          eventY0 = e.changedTouches[0].clientY;\n          scrollBoxY0 = scrollBoxY;\n        }\n      }).on('drag', function () {\n        var e = d3.event.sourceEvent;\n\n        if (e.type === 'touchmove') {\n          eventY1 = e.changedTouches[0].clientY;\n          scrollBoxY = getNaturalDragY(scrollBoxY0, eventY0, eventY1);\n          scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n        }\n      });\n      scrollBox.call(scrollBoxTouchDrag);\n    }\n\n    function scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio) {\n      opts._scrollY = gd._fullLayout.legend._scrollY = scrollBoxY;\n      Drawing.setTranslate(scrollBox, 0, -scrollBoxY);\n      Drawing.setRect(scrollBar, opts._width, constants.scrollBarMargin + scrollBoxY * scrollRatio, constants.scrollBarWidth, scrollBarHeight);\n      clipPath.select('rect').attr('y', bw + scrollBoxY);\n    }\n\n    if (gd._context.edits.legendPosition) {\n      var xf, yf, x0, y0;\n      legend.classed('cursor-move', true);\n      dragElement.init({\n        element: legend.node(),\n        gd: gd,\n        prepFn: function prepFn() {\n          var transform = Drawing.getTranslate(legend);\n          x0 = transform.x;\n          y0 = transform.y;\n        },\n        moveFn: function moveFn(dx, dy) {\n          var newX = x0 + dx;\n          var newY = y0 + dy;\n          Drawing.setTranslate(legend, newX, newY);\n          xf = dragElement.align(newX, 0, gs.l, gs.l + gs.w, opts.xanchor);\n          yf = dragElement.align(newY, 0, gs.t + gs.h, gs.t, opts.yanchor);\n        },\n        doneFn: function doneFn() {\n          if (xf !== undefined && yf !== undefined) {\n            Registry.call('_guiRelayout', gd, {\n              'legend.x': xf,\n              'legend.y': yf\n            });\n          }\n        },\n        clickFn: function clickFn(numClicks, e) {\n          var clickedTrace = layer.selectAll('g.traces').filter(function () {\n            var bbox = this.getBoundingClientRect();\n            return e.clientX >= bbox.left && e.clientX <= bbox.right && e.clientY >= bbox.top && e.clientY <= bbox.bottom;\n          });\n\n          if (clickedTrace.size() > 0) {\n            clickOrDoubleClick(gd, legend, clickedTrace, numClicks, e);\n          }\n        }\n      });\n    }\n  }], gd);\n};\n\nfunction clickOrDoubleClick(gd, legend, legendItem, numClicks, evt) {\n  var trace = legendItem.data()[0][0].trace;\n  var evtData = {\n    event: evt,\n    node: legendItem.node(),\n    curveNumber: trace.index,\n    expandedIndex: trace._expandedIndex,\n    data: gd.data,\n    layout: gd.layout,\n    frames: gd._transitionData._frames,\n    config: gd._context,\n    fullData: gd._fullData,\n    fullLayout: gd._fullLayout\n  };\n\n  if (trace._group) {\n    evtData.group = trace._group;\n  }\n\n  if (Registry.traceIs(trace, 'pie-like')) {\n    evtData.label = legendItem.datum()[0].label;\n  }\n\n  var clickVal = Events.triggerHandler(gd, 'plotly_legendclick', evtData);\n  if (clickVal === false) return;\n\n  if (numClicks === 1) {\n    legend._clickTimeout = setTimeout(function () {\n      handleClick(legendItem, gd, numClicks);\n    }, gd._context.doubleClickDelay);\n  } else if (numClicks === 2) {\n    if (legend._clickTimeout) clearTimeout(legend._clickTimeout);\n    gd._legendMouseDownTime = 0;\n    var dblClickVal = Events.triggerHandler(gd, 'plotly_legenddoubleclick', evtData);\n    if (dblClickVal !== false) handleClick(legendItem, gd, numClicks);\n  }\n}\n\nfunction drawTexts(g, gd, opts) {\n  var legendItem = g.data()[0][0];\n  var trace = legendItem.trace;\n  var isPieLike = Registry.traceIs(trace, 'pie-like');\n  var traceIndex = trace.index;\n  var isEditable = opts._main && gd._context.edits.legendText && !isPieLike;\n  var maxNameLength = opts._maxNameLength;\n  var name;\n\n  if (!opts.entries) {\n    name = isPieLike ? legendItem.label : trace.name;\n\n    if (trace._meta) {\n      name = Lib.templateString(name, trace._meta);\n    }\n  } else {\n    name = legendItem.text;\n  }\n\n  var textEl = Lib.ensureSingle(g, 'text', 'legendtext');\n  textEl.attr('text-anchor', 'start').classed('user-select-none', true).call(Drawing.font, opts.font).text(isEditable ? ensureLength(name, maxNameLength) : name);\n  svgTextUtils.positionText(textEl, constants.textGap, 0);\n\n  if (isEditable) {\n    textEl.call(svgTextUtils.makeEditable, {\n      gd: gd,\n      text: name\n    }).call(textLayout, g, gd, opts).on('edit', function (newName) {\n      this.text(ensureLength(newName, maxNameLength)).call(textLayout, g, gd, opts);\n      var fullInput = legendItem.trace._fullInput || {};\n      var update = {};\n\n      if (Registry.hasTransform(fullInput, 'groupby')) {\n        var groupbyIndices = Registry.getTransformIndices(fullInput, 'groupby');\n        var index = groupbyIndices[groupbyIndices.length - 1];\n        var kcont = Lib.keyedContainer(fullInput, 'transforms[' + index + '].styles', 'target', 'value.name');\n        kcont.set(legendItem.trace._group, newName);\n        update = kcont.constructUpdate();\n      } else {\n        update.name = newName;\n      }\n\n      return Registry.call('_guiRestyle', gd, update, traceIndex);\n    });\n  } else {\n    textLayout(textEl, g, gd, opts);\n  }\n}\n/*\n * Make sure we have a reasonably clickable region.\n * If this string is missing or very short, pad it with spaces out to at least\n * 4 characters, up to the max length of other labels, on the assumption that\n * most characters are wider than spaces so a string of spaces will usually be\n * no wider than the real labels.\n */\n\n\nfunction ensureLength(str, maxLength) {\n  var targetLength = Math.max(4, maxLength);\n  if (str && str.trim().length >= targetLength / 2) return str;\n  str = str || '';\n\n  for (var i = targetLength - str.length; i > 0; i--) {\n    str += ' ';\n  }\n\n  return str;\n}\n\nfunction setupTraceToggle(g, gd) {\n  var doubleClickDelay = gd._context.doubleClickDelay;\n  var newMouseDownTime;\n  var numClicks = 1;\n  var traceToggle = Lib.ensureSingle(g, 'rect', 'legendtoggle', function (s) {\n    s.style('cursor', 'pointer').attr('pointer-events', 'all').call(Color.fill, 'rgba(0,0,0,0)');\n  });\n  traceToggle.on('mousedown', function () {\n    newMouseDownTime = new Date().getTime();\n\n    if (newMouseDownTime - gd._legendMouseDownTime < doubleClickDelay) {\n      // in a click train\n      numClicks += 1;\n    } else {\n      // new click train\n      numClicks = 1;\n      gd._legendMouseDownTime = newMouseDownTime;\n    }\n  });\n  traceToggle.on('mouseup', function () {\n    if (gd._dragged || gd._editing) return;\n    var legend = gd._fullLayout.legend;\n\n    if (new Date().getTime() - gd._legendMouseDownTime > doubleClickDelay) {\n      numClicks = Math.max(numClicks - 1, 1);\n    }\n\n    clickOrDoubleClick(gd, legend, g, numClicks, d3.event);\n  });\n}\n\nfunction textLayout(s, g, gd, opts) {\n  if (!opts._main) s.attr('data-notex', true); // do not process MathJax if not main\n\n  svgTextUtils.convertToTspans(s, gd, function () {\n    computeTextDimensions(g, gd, opts);\n  });\n}\n\nfunction computeTextDimensions(g, gd, opts) {\n  var legendItem = g.data()[0][0];\n\n  if (opts._main && legendItem && !legendItem.trace.showlegend) {\n    g.remove();\n    return;\n  }\n\n  var mathjaxGroup = g.select('g[class*=math-group]');\n  var mathjaxNode = mathjaxGroup.node();\n  if (!opts) opts = gd._fullLayout.legend;\n  var bw = opts.borderwidth;\n  var lineHeight = (legendItem ? opts : opts.title).font.size * LINE_SPACING;\n  var height, width;\n\n  if (mathjaxNode) {\n    var mathjaxBB = Drawing.bBox(mathjaxNode);\n    height = mathjaxBB.height;\n    width = mathjaxBB.width;\n\n    if (legendItem) {\n      Drawing.setTranslate(mathjaxGroup, 0, height * 0.25);\n    } else {\n      // case of title\n      Drawing.setTranslate(mathjaxGroup, bw, height * 0.75 + bw);\n    }\n  } else {\n    var textEl = g.select(legendItem ? '.legendtext' : '.legendtitletext');\n    var textLines = svgTextUtils.lineCount(textEl);\n    var textNode = textEl.node();\n    height = lineHeight * textLines;\n    width = textNode ? Drawing.bBox(textNode).width : 0; // approximation to height offset to center the font\n    // to avoid getBoundingClientRect\n\n    var textY = lineHeight * ((textLines - 1) / 2 - 0.3);\n\n    if (legendItem) {\n      svgTextUtils.positionText(textEl, constants.textGap, -textY);\n    } else {\n      // case of title\n      svgTextUtils.positionText(textEl, constants.titlePad + bw, lineHeight + bw);\n    }\n  }\n\n  if (legendItem) {\n    legendItem.lineHeight = lineHeight;\n    legendItem.height = Math.max(height, 16) + 3;\n    legendItem.width = width;\n  } else {\n    // case of title\n    opts._titleWidth = width;\n    opts._titleHeight = height;\n  }\n}\n\nfunction getTitleSize(opts) {\n  var w = 0;\n  var h = 0;\n  var side = opts.title.side;\n\n  if (side) {\n    if (side.indexOf('left') !== -1) {\n      w = opts._titleWidth;\n    }\n\n    if (side.indexOf('top') !== -1) {\n      h = opts._titleHeight;\n    }\n  }\n\n  return [w, h];\n}\n/*\n * Computes in fullLayout.legend:\n *\n *  - _height: legend height including items past scrollbox height\n *  - _maxHeight: maximum legend height before scrollbox is required\n *  - _effHeight: legend height w/ or w/o scrollbox\n *\n *  - _width: legend width\n *  - _maxWidth (for orientation:h only): maximum width before starting new row\n */\n\n\nfunction computeLegendDimensions(gd, groups, traces, opts) {\n  var fullLayout = gd._fullLayout;\n  if (!opts) opts = fullLayout.legend;\n  var gs = fullLayout._size;\n  var isVertical = helpers.isVertical(opts);\n  var isGrouped = helpers.isGrouped(opts);\n  var bw = opts.borderwidth;\n  var bw2 = 2 * bw;\n  var textGap = constants.textGap;\n  var itemGap = constants.itemGap;\n  var endPad = 2 * (bw + itemGap);\n  var yanchor = getYanchor(opts);\n  var isBelowPlotArea = opts.y < 0 || opts.y === 0 && yanchor === 'top';\n  var isAbovePlotArea = opts.y > 1 || opts.y === 1 && yanchor === 'bottom'; // - if below/above plot area, give it the maximum potential margin-push value\n  // - otherwise, extend the height of the plot area\n\n  opts._maxHeight = Math.max(isBelowPlotArea || isAbovePlotArea ? fullLayout.height / 2 : gs.h, 30);\n  var toggleRectWidth = 0;\n  opts._width = 0;\n  opts._height = 0;\n  var titleSize = getTitleSize(opts);\n\n  if (isVertical) {\n    traces.each(function (d) {\n      var h = d[0].height;\n      Drawing.setTranslate(this, bw + titleSize[0], bw + titleSize[1] + opts._height + h / 2 + itemGap);\n      opts._height += h;\n      opts._width = Math.max(opts._width, d[0].width);\n    });\n    toggleRectWidth = textGap + opts._width;\n    opts._width += itemGap + textGap + bw2;\n    opts._height += endPad;\n\n    if (isGrouped) {\n      groups.each(function (d, i) {\n        Drawing.setTranslate(this, 0, i * opts.tracegroupgap);\n      });\n      opts._height += (opts._lgroupsLength - 1) * opts.tracegroupgap;\n    }\n  } else {\n    var xanchor = getXanchor(opts);\n    var isLeftOfPlotArea = opts.x < 0 || opts.x === 0 && xanchor === 'right';\n    var isRightOfPlotArea = opts.x > 1 || opts.x === 1 && xanchor === 'left';\n    var isBeyondPlotAreaY = isAbovePlotArea || isBelowPlotArea;\n    var hw = fullLayout.width / 2; // - if placed within x-margins, extend the width of the plot area\n    // - else if below/above plot area and anchored in the margin, extend to opposite margin,\n    // - otherwise give it the maximum potential margin-push value\n\n    opts._maxWidth = Math.max(isLeftOfPlotArea ? isBeyondPlotAreaY && xanchor === 'left' ? gs.l + gs.w : hw : isRightOfPlotArea ? isBeyondPlotAreaY && xanchor === 'right' ? gs.r + gs.w : hw : gs.w, 2 * textGap);\n    var maxItemWidth = 0;\n    var combinedItemWidth = 0;\n    traces.each(function (d) {\n      var w = d[0].width + textGap;\n      maxItemWidth = Math.max(maxItemWidth, w);\n      combinedItemWidth += w;\n    });\n    toggleRectWidth = null;\n    var maxRowWidth = 0;\n\n    if (isGrouped) {\n      var maxGroupHeightInRow = 0;\n      var groupOffsetX = 0;\n      var groupOffsetY = 0;\n      groups.each(function () {\n        var maxWidthInGroup = 0;\n        var offsetY = 0;\n        d3.select(this).selectAll('g.traces').each(function (d) {\n          var h = d[0].height;\n          Drawing.setTranslate(this, titleSize[0], titleSize[1] + bw + itemGap + h / 2 + offsetY);\n          offsetY += h;\n          maxWidthInGroup = Math.max(maxWidthInGroup, textGap + d[0].width);\n        });\n        maxGroupHeightInRow = Math.max(maxGroupHeightInRow, offsetY);\n        var next = maxWidthInGroup + itemGap;\n\n        if (next + bw + groupOffsetX > opts._maxWidth) {\n          maxRowWidth = Math.max(maxRowWidth, groupOffsetX);\n          groupOffsetX = 0;\n          groupOffsetY += maxGroupHeightInRow + opts.tracegroupgap;\n          maxGroupHeightInRow = offsetY;\n        }\n\n        Drawing.setTranslate(this, groupOffsetX, groupOffsetY);\n        groupOffsetX += next;\n      });\n      opts._width = Math.max(maxRowWidth, groupOffsetX) + bw;\n      opts._height = groupOffsetY + maxGroupHeightInRow + endPad;\n    } else {\n      var nTraces = traces.size();\n      var oneRowLegend = combinedItemWidth + bw2 + (nTraces - 1) * itemGap < opts._maxWidth;\n      var maxItemHeightInRow = 0;\n      var offsetX = 0;\n      var offsetY = 0;\n      var rowWidth = 0;\n      traces.each(function (d) {\n        var h = d[0].height;\n        var w = textGap + d[0].width;\n        var next = (oneRowLegend ? w : maxItemWidth) + itemGap;\n\n        if (next + bw + offsetX > opts._maxWidth) {\n          maxRowWidth = Math.max(maxRowWidth, rowWidth);\n          offsetX = 0;\n          offsetY += maxItemHeightInRow;\n          opts._height += maxItemHeightInRow;\n          maxItemHeightInRow = 0;\n        }\n\n        Drawing.setTranslate(this, titleSize[0] + bw + offsetX, titleSize[1] + bw + offsetY + h / 2 + itemGap);\n        rowWidth = offsetX + w + itemGap;\n        offsetX += next;\n        maxItemHeightInRow = Math.max(maxItemHeightInRow, h);\n      });\n\n      if (oneRowLegend) {\n        opts._width = offsetX + bw2;\n        opts._height = maxItemHeightInRow + endPad;\n      } else {\n        opts._width = Math.max(maxRowWidth, rowWidth) + bw2;\n        opts._height += maxItemHeightInRow + endPad;\n      }\n    }\n  }\n\n  opts._width = Math.ceil(Math.max(opts._width + titleSize[0], opts._titleWidth + 2 * (bw + constants.titlePad)));\n  opts._height = Math.ceil(Math.max(opts._height + titleSize[1], opts._titleHeight + 2 * (bw + constants.itemGap)));\n  opts._effHeight = Math.min(opts._height, opts._maxHeight);\n  var edits = gd._context.edits;\n  var isEditable = edits.legendText || edits.legendPosition;\n  traces.each(function (d) {\n    var traceToggle = d3.select(this).select('.legendtoggle');\n    var h = d[0].height;\n    var w = isEditable ? textGap : toggleRectWidth || textGap + d[0].width;\n    if (!isVertical) w += itemGap / 2;\n    Drawing.setRect(traceToggle, 0, -h / 2, w, h);\n  });\n}\n\nfunction expandMargin(gd) {\n  var fullLayout = gd._fullLayout;\n  var opts = fullLayout.legend;\n  var xanchor = getXanchor(opts);\n  var yanchor = getYanchor(opts);\n  return Plots.autoMargin(gd, 'legend', {\n    x: opts.x,\n    y: opts.y,\n    l: opts._width * FROM_TL[xanchor],\n    r: opts._width * FROM_BR[xanchor],\n    b: opts._effHeight * FROM_BR[yanchor],\n    t: opts._effHeight * FROM_TL[yanchor]\n  });\n}\n\nfunction getXanchor(opts) {\n  return Lib.isRightAnchor(opts) ? 'right' : Lib.isCenterAnchor(opts) ? 'center' : 'left';\n}\n\nfunction getYanchor(opts) {\n  return Lib.isBottomAnchor(opts) ? 'bottom' : Lib.isMiddleAnchor(opts) ? 'middle' : 'top';\n}","map":{"version":3,"sources":["/home/raj/go/src/github.com/litmuschaos/litmus/litmus-portal/frontend/node_modules/plotly.js/src/components/legend/draw.js"],"names":["d3","require","Lib","Plots","Registry","Events","dragElement","Drawing","Color","svgTextUtils","handleClick","constants","alignmentConstants","LINE_SPACING","FROM_TL","FROM_BR","getLegendData","style","helpers","module","exports","draw","gd","opts","fullLayout","_fullLayout","clipId","_uid","layer","legend","_main","_infolayer","_legendMouseDownTime","legendData","calcdata","showlegend","entries","hiddenSlices","hiddenlabels","length","selectAll","remove","_topdefs","select","autoMargin","ensureSingle","s","attr","clipPath","ensureSingleById","append","bg","call","stroke","bordercolor","fill","bgcolor","borderwidth","scrollBox","title","_titleWidth","_titleHeight","text","titleEl","classed","font","textLayout","scrollBar","scrollBarEnterAttrs","scrollBarColor","groups","data","enter","exit","traces","identity","d","trace","traceIs","indexOf","label","visible","each","drawTexts","setupTraceToggle","syncOrAsync","previousPromises","computeLegendDimensions","expandMargin","gs","_size","bw","lx","l","w","x","getXanchor","_width","ly","t","h","y","getYanchor","_effHeight","margin","autoexpand","lx0","ly0","constrain","width","height","log","setTranslate","on","_height","_maxHeight","_context","staticPlot","setClipUrl","setRect","_scrollY","scrollBarHeight","Math","max","scrollBarMinHeight","scrollBarYMax","scrollBarMargin","scrollBoxYMax","scrollRatio","scrollBoxY","min","scrollBarWidth","scrollHandler","event","deltaY","preventDefault","eventY0","eventY1","scrollBoxY0","getScrollBarDragY","getNaturalDragY","scrollBarDrag","behavior","drag","e","sourceEvent","type","changedTouches","clientY","buttons","ctrlKey","scrollBoxTouchDrag","edits","legendPosition","xf","yf","x0","y0","init","element","node","prepFn","transform","getTranslate","moveFn","dx","dy","newX","newY","align","xanchor","yanchor","doneFn","undefined","clickFn","numClicks","clickedTrace","filter","bbox","getBoundingClientRect","clientX","left","right","top","bottom","size","clickOrDoubleClick","legendItem","evt","evtData","curveNumber","index","expandedIndex","_expandedIndex","layout","frames","_transitionData","_frames","config","fullData","_fullData","_group","group","datum","clickVal","triggerHandler","_clickTimeout","setTimeout","doubleClickDelay","clearTimeout","dblClickVal","g","isPieLike","traceIndex","isEditable","legendText","maxNameLength","_maxNameLength","name","_meta","templateString","textEl","ensureLength","positionText","textGap","makeEditable","newName","fullInput","_fullInput","update","hasTransform","groupbyIndices","getTransformIndices","kcont","keyedContainer","set","constructUpdate","str","maxLength","targetLength","trim","i","newMouseDownTime","traceToggle","Date","getTime","_dragged","_editing","convertToTspans","computeTextDimensions","mathjaxGroup","mathjaxNode","lineHeight","mathjaxBB","bBox","textLines","lineCount","textNode","textY","titlePad","getTitleSize","side","isVertical","isGrouped","bw2","itemGap","endPad","isBelowPlotArea","isAbovePlotArea","toggleRectWidth","titleSize","tracegroupgap","_lgroupsLength","isLeftOfPlotArea","isRightOfPlotArea","isBeyondPlotAreaY","hw","_maxWidth","r","maxItemWidth","combinedItemWidth","maxRowWidth","maxGroupHeightInRow","groupOffsetX","groupOffsetY","maxWidthInGroup","offsetY","next","nTraces","oneRowLegend","maxItemHeightInRow","offsetX","rowWidth","ceil","b","isRightAnchor","isCenterAnchor","isBottomAnchor","isMiddleAnchor"],"mappings":"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","sourcesContent":["/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar d3 = require('d3');\n\nvar Lib = require('../../lib');\nvar Plots = require('../../plots/plots');\nvar Registry = require('../../registry');\nvar Events = require('../../lib/events');\nvar dragElement = require('../dragelement');\nvar Drawing = require('../drawing');\nvar Color = require('../color');\nvar svgTextUtils = require('../../lib/svg_text_utils');\nvar handleClick = require('./handle_click');\n\nvar constants = require('./constants');\nvar alignmentConstants = require('../../constants/alignment');\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar FROM_TL = alignmentConstants.FROM_TL;\nvar FROM_BR = alignmentConstants.FROM_BR;\n\nvar getLegendData = require('./get_legend_data');\nvar style = require('./style');\nvar helpers = require('./helpers');\n\nmodule.exports = function draw(gd, opts) {\n    var fullLayout = gd._fullLayout;\n    var clipId = 'legend' + fullLayout._uid;\n    var layer;\n\n    // Check whether this is the main legend (ie. called without any opts)\n    if(!opts) {\n        opts = fullLayout.legend || {};\n        opts._main = true;\n        layer = fullLayout._infolayer;\n    } else {\n        layer = opts.layer;\n        clipId += '-hover';\n    }\n\n    if(!layer) return;\n\n    if(!gd._legendMouseDownTime) gd._legendMouseDownTime = 0;\n\n    var legendData;\n    if(opts._main) {\n        if(!gd.calcdata) return;\n        legendData = fullLayout.showlegend && getLegendData(gd.calcdata, opts);\n    } else {\n        if(!opts.entries) return;\n        legendData = getLegendData(opts.entries, opts);\n    }\n\n    var hiddenSlices = fullLayout.hiddenlabels || [];\n\n    if(opts._main && (!fullLayout.showlegend || !legendData.length)) {\n        layer.selectAll('.legend').remove();\n        fullLayout._topdefs.select('#' + clipId).remove();\n        return Plots.autoMargin(gd, 'legend');\n    }\n\n    var legend = Lib.ensureSingle(layer, 'g', 'legend', function(s) {\n        if(opts._main) s.attr('pointer-events', 'all');\n    });\n\n    var clipPath = Lib.ensureSingleById(fullLayout._topdefs, 'clipPath', clipId, function(s) {\n        s.append('rect');\n    });\n\n    var bg = Lib.ensureSingle(legend, 'rect', 'bg', function(s) {\n        s.attr('shape-rendering', 'crispEdges');\n    });\n    bg.call(Color.stroke, opts.bordercolor)\n        .call(Color.fill, opts.bgcolor)\n        .style('stroke-width', opts.borderwidth + 'px');\n\n    var scrollBox = Lib.ensureSingle(legend, 'g', 'scrollbox');\n\n    var title = opts.title;\n    opts._titleWidth = 0;\n    opts._titleHeight = 0;\n    if(title.text) {\n        var titleEl = Lib.ensureSingle(scrollBox, 'text', 'legendtitletext');\n        titleEl.attr('text-anchor', 'start')\n            .classed('user-select-none', true)\n            .call(Drawing.font, title.font)\n            .text(title.text);\n\n        textLayout(titleEl, scrollBox, gd, opts); // handle mathjax or multi-line text and compute title height\n    } else {\n        scrollBox.selectAll('.legendtitletext').remove();\n    }\n\n    var scrollBar = Lib.ensureSingle(legend, 'rect', 'scrollbar', function(s) {\n        s.attr(constants.scrollBarEnterAttrs)\n         .call(Color.fill, constants.scrollBarColor);\n    });\n\n    var groups = scrollBox.selectAll('g.groups').data(legendData);\n    groups.enter().append('g').attr('class', 'groups');\n    groups.exit().remove();\n\n    var traces = groups.selectAll('g.traces').data(Lib.identity);\n    traces.enter().append('g').attr('class', 'traces');\n    traces.exit().remove();\n\n    traces.style('opacity', function(d) {\n        var trace = d[0].trace;\n        if(Registry.traceIs(trace, 'pie-like')) {\n            return hiddenSlices.indexOf(d[0].label) !== -1 ? 0.5 : 1;\n        } else {\n            return trace.visible === 'legendonly' ? 0.5 : 1;\n        }\n    })\n    .each(function() { d3.select(this).call(drawTexts, gd, opts); })\n    .call(style, gd, opts)\n    .each(function() { if(opts._main) d3.select(this).call(setupTraceToggle, gd); });\n\n    Lib.syncOrAsync([\n        Plots.previousPromises,\n        function() { return computeLegendDimensions(gd, groups, traces, opts); },\n        function() {\n            // IF expandMargin return a Promise (which is truthy),\n            // we're under a doAutoMargin redraw, so we don't have to\n            // draw the remaining pieces below\n            if(opts._main && expandMargin(gd)) return;\n\n            var gs = fullLayout._size;\n            var bw = opts.borderwidth;\n\n            var lx = gs.l + gs.w * opts.x - FROM_TL[getXanchor(opts)] * opts._width;\n            var ly = gs.t + gs.h * (1 - opts.y) - FROM_TL[getYanchor(opts)] * opts._effHeight;\n\n            if(opts._main && fullLayout.margin.autoexpand) {\n                var lx0 = lx;\n                var ly0 = ly;\n\n                lx = Lib.constrain(lx, 0, fullLayout.width - opts._width);\n                ly = Lib.constrain(ly, 0, fullLayout.height - opts._effHeight);\n\n                if(lx !== lx0) {\n                    Lib.log('Constrain legend.x to make legend fit inside graph');\n                }\n                if(ly !== ly0) {\n                    Lib.log('Constrain legend.y to make legend fit inside graph');\n                }\n            }\n\n            // Set size and position of all the elements that make up a legend:\n            // legend, background and border, scroll box and scroll bar as well as title\n            if(opts._main) Drawing.setTranslate(legend, lx, ly);\n\n            // to be safe, remove previous listeners\n            scrollBar.on('.drag', null);\n            legend.on('wheel', null);\n\n            if(!opts._main || opts._height <= opts._maxHeight || gd._context.staticPlot) {\n                // if scrollbar should not be shown.\n                var height = opts._effHeight;\n\n                // if not the main legend, let it be its full size\n                if(!opts._main) height = opts._height;\n\n                bg.attr({\n                    width: opts._width - bw,\n                    height: height - bw,\n                    x: bw / 2,\n                    y: bw / 2\n                });\n\n                Drawing.setTranslate(scrollBox, 0, 0);\n\n                clipPath.select('rect').attr({\n                    width: opts._width - 2 * bw,\n                    height: height - 2 * bw,\n                    x: bw,\n                    y: bw\n                });\n\n                Drawing.setClipUrl(scrollBox, clipId, gd);\n\n                Drawing.setRect(scrollBar, 0, 0, 0, 0);\n                delete opts._scrollY;\n            } else {\n                var scrollBarHeight = Math.max(constants.scrollBarMinHeight,\n                    opts._effHeight * opts._effHeight / opts._height);\n                var scrollBarYMax = opts._effHeight -\n                    scrollBarHeight -\n                    2 * constants.scrollBarMargin;\n                var scrollBoxYMax = opts._height - opts._effHeight;\n                var scrollRatio = scrollBarYMax / scrollBoxYMax;\n\n                var scrollBoxY = Math.min(opts._scrollY || 0, scrollBoxYMax);\n\n                // increase the background and clip-path width\n                // by the scrollbar width and margin\n                bg.attr({\n                    width: opts._width -\n                        2 * bw +\n                        constants.scrollBarWidth +\n                        constants.scrollBarMargin,\n                    height: opts._effHeight - bw,\n                    x: bw / 2,\n                    y: bw / 2\n                });\n\n                clipPath.select('rect').attr({\n                    width: opts._width -\n                        2 * bw +\n                        constants.scrollBarWidth +\n                        constants.scrollBarMargin,\n                    height: opts._effHeight - 2 * bw,\n                    x: bw,\n                    y: bw + scrollBoxY\n                });\n\n                Drawing.setClipUrl(scrollBox, clipId, gd);\n\n                scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n\n                // scroll legend by mousewheel or touchpad swipe up/down\n                legend.on('wheel', function() {\n                    scrollBoxY = Lib.constrain(\n                        opts._scrollY +\n                            ((d3.event.deltaY / scrollBarYMax) * scrollBoxYMax),\n                        0, scrollBoxYMax);\n                    scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n                    if(scrollBoxY !== 0 && scrollBoxY !== scrollBoxYMax) {\n                        d3.event.preventDefault();\n                    }\n                });\n\n                var eventY0, eventY1, scrollBoxY0;\n\n                var getScrollBarDragY = function(scrollBoxY0, eventY0, eventY1) {\n                    var y = ((eventY1 - eventY0) / scrollRatio) + scrollBoxY0;\n                    return Lib.constrain(y, 0, scrollBoxYMax);\n                };\n\n                var getNaturalDragY = function(scrollBoxY0, eventY0, eventY1) {\n                    var y = ((eventY0 - eventY1) / scrollRatio) + scrollBoxY0;\n                    return Lib.constrain(y, 0, scrollBoxYMax);\n                };\n\n                // scroll legend by dragging scrollBAR\n                var scrollBarDrag = d3.behavior.drag()\n                .on('dragstart', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.type === 'touchstart') {\n                        eventY0 = e.changedTouches[0].clientY;\n                    } else {\n                        eventY0 = e.clientY;\n                    }\n                    scrollBoxY0 = scrollBoxY;\n                })\n                .on('drag', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.buttons === 2 || e.ctrlKey) return;\n                    if(e.type === 'touchmove') {\n                        eventY1 = e.changedTouches[0].clientY;\n                    } else {\n                        eventY1 = e.clientY;\n                    }\n                    scrollBoxY = getScrollBarDragY(scrollBoxY0, eventY0, eventY1);\n                    scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n                });\n                scrollBar.call(scrollBarDrag);\n\n                // scroll legend by touch-dragging scrollBOX\n                var scrollBoxTouchDrag = d3.behavior.drag()\n                .on('dragstart', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.type === 'touchstart') {\n                        eventY0 = e.changedTouches[0].clientY;\n                        scrollBoxY0 = scrollBoxY;\n                    }\n                })\n                .on('drag', function() {\n                    var e = d3.event.sourceEvent;\n                    if(e.type === 'touchmove') {\n                        eventY1 = e.changedTouches[0].clientY;\n                        scrollBoxY = getNaturalDragY(scrollBoxY0, eventY0, eventY1);\n                        scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio);\n                    }\n                });\n                scrollBox.call(scrollBoxTouchDrag);\n            }\n\n            function scrollHandler(scrollBoxY, scrollBarHeight, scrollRatio) {\n                opts._scrollY = gd._fullLayout.legend._scrollY = scrollBoxY;\n                Drawing.setTranslate(scrollBox, 0, -scrollBoxY);\n\n                Drawing.setRect(\n                    scrollBar,\n                    opts._width,\n                    constants.scrollBarMargin + scrollBoxY * scrollRatio,\n                    constants.scrollBarWidth,\n                    scrollBarHeight\n                );\n                clipPath.select('rect').attr('y', bw + scrollBoxY);\n            }\n\n            if(gd._context.edits.legendPosition) {\n                var xf, yf, x0, y0;\n\n                legend.classed('cursor-move', true);\n\n                dragElement.init({\n                    element: legend.node(),\n                    gd: gd,\n                    prepFn: function() {\n                        var transform = Drawing.getTranslate(legend);\n                        x0 = transform.x;\n                        y0 = transform.y;\n                    },\n                    moveFn: function(dx, dy) {\n                        var newX = x0 + dx;\n                        var newY = y0 + dy;\n\n                        Drawing.setTranslate(legend, newX, newY);\n\n                        xf = dragElement.align(newX, 0, gs.l, gs.l + gs.w, opts.xanchor);\n                        yf = dragElement.align(newY, 0, gs.t + gs.h, gs.t, opts.yanchor);\n                    },\n                    doneFn: function() {\n                        if(xf !== undefined && yf !== undefined) {\n                            Registry.call('_guiRelayout', gd, {'legend.x': xf, 'legend.y': yf});\n                        }\n                    },\n                    clickFn: function(numClicks, e) {\n                        var clickedTrace = layer.selectAll('g.traces').filter(function() {\n                            var bbox = this.getBoundingClientRect();\n                            return (\n                                e.clientX >= bbox.left && e.clientX <= bbox.right &&\n                                e.clientY >= bbox.top && e.clientY <= bbox.bottom\n                            );\n                        });\n                        if(clickedTrace.size() > 0) {\n                            clickOrDoubleClick(gd, legend, clickedTrace, numClicks, e);\n                        }\n                    }\n                });\n            }\n        }], gd);\n};\n\nfunction clickOrDoubleClick(gd, legend, legendItem, numClicks, evt) {\n    var trace = legendItem.data()[0][0].trace;\n    var evtData = {\n        event: evt,\n        node: legendItem.node(),\n        curveNumber: trace.index,\n        expandedIndex: trace._expandedIndex,\n        data: gd.data,\n        layout: gd.layout,\n        frames: gd._transitionData._frames,\n        config: gd._context,\n        fullData: gd._fullData,\n        fullLayout: gd._fullLayout\n    };\n\n    if(trace._group) {\n        evtData.group = trace._group;\n    }\n    if(Registry.traceIs(trace, 'pie-like')) {\n        evtData.label = legendItem.datum()[0].label;\n    }\n\n    var clickVal = Events.triggerHandler(gd, 'plotly_legendclick', evtData);\n    if(clickVal === false) return;\n\n    if(numClicks === 1) {\n        legend._clickTimeout = setTimeout(function() {\n            handleClick(legendItem, gd, numClicks);\n        }, gd._context.doubleClickDelay);\n    } else if(numClicks === 2) {\n        if(legend._clickTimeout) clearTimeout(legend._clickTimeout);\n        gd._legendMouseDownTime = 0;\n\n        var dblClickVal = Events.triggerHandler(gd, 'plotly_legenddoubleclick', evtData);\n        if(dblClickVal !== false) handleClick(legendItem, gd, numClicks);\n    }\n}\n\nfunction drawTexts(g, gd, opts) {\n    var legendItem = g.data()[0][0];\n    var trace = legendItem.trace;\n    var isPieLike = Registry.traceIs(trace, 'pie-like');\n    var traceIndex = trace.index;\n    var isEditable = opts._main && gd._context.edits.legendText && !isPieLike;\n    var maxNameLength = opts._maxNameLength;\n\n    var name;\n    if(!opts.entries) {\n        name = isPieLike ? legendItem.label : trace.name;\n        if(trace._meta) {\n            name = Lib.templateString(name, trace._meta);\n        }\n    } else {\n        name = legendItem.text;\n    }\n\n    var textEl = Lib.ensureSingle(g, 'text', 'legendtext');\n\n    textEl.attr('text-anchor', 'start')\n        .classed('user-select-none', true)\n        .call(Drawing.font, opts.font)\n        .text(isEditable ? ensureLength(name, maxNameLength) : name);\n\n    svgTextUtils.positionText(textEl, constants.textGap, 0);\n\n    if(isEditable) {\n        textEl.call(svgTextUtils.makeEditable, {gd: gd, text: name})\n            .call(textLayout, g, gd, opts)\n            .on('edit', function(newName) {\n                this.text(ensureLength(newName, maxNameLength))\n                    .call(textLayout, g, gd, opts);\n\n                var fullInput = legendItem.trace._fullInput || {};\n                var update = {};\n\n                if(Registry.hasTransform(fullInput, 'groupby')) {\n                    var groupbyIndices = Registry.getTransformIndices(fullInput, 'groupby');\n                    var index = groupbyIndices[groupbyIndices.length - 1];\n\n                    var kcont = Lib.keyedContainer(fullInput, 'transforms[' + index + '].styles', 'target', 'value.name');\n\n                    kcont.set(legendItem.trace._group, newName);\n\n                    update = kcont.constructUpdate();\n                } else {\n                    update.name = newName;\n                }\n\n                return Registry.call('_guiRestyle', gd, update, traceIndex);\n            });\n    } else {\n        textLayout(textEl, g, gd, opts);\n    }\n}\n\n/*\n * Make sure we have a reasonably clickable region.\n * If this string is missing or very short, pad it with spaces out to at least\n * 4 characters, up to the max length of other labels, on the assumption that\n * most characters are wider than spaces so a string of spaces will usually be\n * no wider than the real labels.\n */\nfunction ensureLength(str, maxLength) {\n    var targetLength = Math.max(4, maxLength);\n    if(str && str.trim().length >= targetLength / 2) return str;\n    str = str || '';\n    for(var i = targetLength - str.length; i > 0; i--) str += ' ';\n    return str;\n}\n\nfunction setupTraceToggle(g, gd) {\n    var doubleClickDelay = gd._context.doubleClickDelay;\n    var newMouseDownTime;\n    var numClicks = 1;\n\n    var traceToggle = Lib.ensureSingle(g, 'rect', 'legendtoggle', function(s) {\n        s.style('cursor', 'pointer')\n            .attr('pointer-events', 'all')\n            .call(Color.fill, 'rgba(0,0,0,0)');\n    });\n\n    traceToggle.on('mousedown', function() {\n        newMouseDownTime = (new Date()).getTime();\n        if(newMouseDownTime - gd._legendMouseDownTime < doubleClickDelay) {\n            // in a click train\n            numClicks += 1;\n        } else {\n            // new click train\n            numClicks = 1;\n            gd._legendMouseDownTime = newMouseDownTime;\n        }\n    });\n    traceToggle.on('mouseup', function() {\n        if(gd._dragged || gd._editing) return;\n        var legend = gd._fullLayout.legend;\n\n        if((new Date()).getTime() - gd._legendMouseDownTime > doubleClickDelay) {\n            numClicks = Math.max(numClicks - 1, 1);\n        }\n\n        clickOrDoubleClick(gd, legend, g, numClicks, d3.event);\n    });\n}\n\nfunction textLayout(s, g, gd, opts) {\n    if(!opts._main) s.attr('data-notex', true); // do not process MathJax if not main\n    svgTextUtils.convertToTspans(s, gd, function() {\n        computeTextDimensions(g, gd, opts);\n    });\n}\n\nfunction computeTextDimensions(g, gd, opts) {\n    var legendItem = g.data()[0][0];\n    if(opts._main && legendItem && !legendItem.trace.showlegend) {\n        g.remove();\n        return;\n    }\n\n    var mathjaxGroup = g.select('g[class*=math-group]');\n    var mathjaxNode = mathjaxGroup.node();\n    if(!opts) opts = gd._fullLayout.legend;\n    var bw = opts.borderwidth;\n    var lineHeight = (legendItem ? opts : opts.title).font.size * LINE_SPACING;\n    var height, width;\n\n    if(mathjaxNode) {\n        var mathjaxBB = Drawing.bBox(mathjaxNode);\n\n        height = mathjaxBB.height;\n        width = mathjaxBB.width;\n\n        if(legendItem) {\n            Drawing.setTranslate(mathjaxGroup, 0, height * 0.25);\n        } else { // case of title\n            Drawing.setTranslate(mathjaxGroup, bw, height * 0.75 + bw);\n        }\n    } else {\n        var textEl = g.select(legendItem ?\n            '.legendtext' : '.legendtitletext'\n        );\n        var textLines = svgTextUtils.lineCount(textEl);\n        var textNode = textEl.node();\n\n        height = lineHeight * textLines;\n        width = textNode ? Drawing.bBox(textNode).width : 0;\n\n        // approximation to height offset to center the font\n        // to avoid getBoundingClientRect\n        var textY = lineHeight * ((textLines - 1) / 2 - 0.3);\n        if(legendItem) {\n            svgTextUtils.positionText(textEl, constants.textGap, -textY);\n        } else { // case of title\n            svgTextUtils.positionText(textEl, constants.titlePad + bw, lineHeight + bw);\n        }\n    }\n\n    if(legendItem) {\n        legendItem.lineHeight = lineHeight;\n        legendItem.height = Math.max(height, 16) + 3;\n        legendItem.width = width;\n    } else { // case of title\n        opts._titleWidth = width;\n        opts._titleHeight = height;\n    }\n}\n\nfunction getTitleSize(opts) {\n    var w = 0;\n    var h = 0;\n\n    var side = opts.title.side;\n    if(side) {\n        if(side.indexOf('left') !== -1) {\n            w = opts._titleWidth;\n        }\n        if(side.indexOf('top') !== -1) {\n            h = opts._titleHeight;\n        }\n    }\n\n    return [w, h];\n}\n\n/*\n * Computes in fullLayout.legend:\n *\n *  - _height: legend height including items past scrollbox height\n *  - _maxHeight: maximum legend height before scrollbox is required\n *  - _effHeight: legend height w/ or w/o scrollbox\n *\n *  - _width: legend width\n *  - _maxWidth (for orientation:h only): maximum width before starting new row\n */\nfunction computeLegendDimensions(gd, groups, traces, opts) {\n    var fullLayout = gd._fullLayout;\n    if(!opts) opts = fullLayout.legend;\n    var gs = fullLayout._size;\n\n    var isVertical = helpers.isVertical(opts);\n    var isGrouped = helpers.isGrouped(opts);\n\n    var bw = opts.borderwidth;\n    var bw2 = 2 * bw;\n    var textGap = constants.textGap;\n    var itemGap = constants.itemGap;\n    var endPad = 2 * (bw + itemGap);\n\n    var yanchor = getYanchor(opts);\n    var isBelowPlotArea = opts.y < 0 || (opts.y === 0 && yanchor === 'top');\n    var isAbovePlotArea = opts.y > 1 || (opts.y === 1 && yanchor === 'bottom');\n\n    // - if below/above plot area, give it the maximum potential margin-push value\n    // - otherwise, extend the height of the plot area\n    opts._maxHeight = Math.max(\n        (isBelowPlotArea || isAbovePlotArea) ? fullLayout.height / 2 : gs.h,\n        30\n    );\n\n    var toggleRectWidth = 0;\n    opts._width = 0;\n    opts._height = 0;\n    var titleSize = getTitleSize(opts);\n\n    if(isVertical) {\n        traces.each(function(d) {\n            var h = d[0].height;\n            Drawing.setTranslate(this,\n                bw + titleSize[0],\n                bw + titleSize[1] + opts._height + h / 2 + itemGap\n            );\n            opts._height += h;\n            opts._width = Math.max(opts._width, d[0].width);\n        });\n\n        toggleRectWidth = textGap + opts._width;\n        opts._width += itemGap + textGap + bw2;\n        opts._height += endPad;\n\n        if(isGrouped) {\n            groups.each(function(d, i) {\n                Drawing.setTranslate(this, 0, i * opts.tracegroupgap);\n            });\n            opts._height += (opts._lgroupsLength - 1) * opts.tracegroupgap;\n        }\n    } else {\n        var xanchor = getXanchor(opts);\n        var isLeftOfPlotArea = opts.x < 0 || (opts.x === 0 && xanchor === 'right');\n        var isRightOfPlotArea = opts.x > 1 || (opts.x === 1 && xanchor === 'left');\n        var isBeyondPlotAreaY = isAbovePlotArea || isBelowPlotArea;\n        var hw = fullLayout.width / 2;\n\n        // - if placed within x-margins, extend the width of the plot area\n        // - else if below/above plot area and anchored in the margin, extend to opposite margin,\n        // - otherwise give it the maximum potential margin-push value\n        opts._maxWidth = Math.max(\n            isLeftOfPlotArea ? ((isBeyondPlotAreaY && xanchor === 'left') ? gs.l + gs.w : hw) :\n            isRightOfPlotArea ? ((isBeyondPlotAreaY && xanchor === 'right') ? gs.r + gs.w : hw) :\n            gs.w,\n        2 * textGap);\n        var maxItemWidth = 0;\n        var combinedItemWidth = 0;\n        traces.each(function(d) {\n            var w = d[0].width + textGap;\n            maxItemWidth = Math.max(maxItemWidth, w);\n            combinedItemWidth += w;\n        });\n\n        toggleRectWidth = null;\n        var maxRowWidth = 0;\n\n        if(isGrouped) {\n            var maxGroupHeightInRow = 0;\n            var groupOffsetX = 0;\n            var groupOffsetY = 0;\n            groups.each(function() {\n                var maxWidthInGroup = 0;\n                var offsetY = 0;\n                d3.select(this).selectAll('g.traces').each(function(d) {\n                    var h = d[0].height;\n                    Drawing.setTranslate(this,\n                        titleSize[0],\n                        titleSize[1] + bw + itemGap + h / 2 + offsetY\n                    );\n                    offsetY += h;\n                    maxWidthInGroup = Math.max(maxWidthInGroup, textGap + d[0].width);\n                });\n                maxGroupHeightInRow = Math.max(maxGroupHeightInRow, offsetY);\n\n                var next = maxWidthInGroup + itemGap;\n\n                if((next + bw + groupOffsetX) > opts._maxWidth) {\n                    maxRowWidth = Math.max(maxRowWidth, groupOffsetX);\n                    groupOffsetX = 0;\n                    groupOffsetY += maxGroupHeightInRow + opts.tracegroupgap;\n                    maxGroupHeightInRow = offsetY;\n                }\n\n                Drawing.setTranslate(this, groupOffsetX, groupOffsetY);\n\n                groupOffsetX += next;\n            });\n\n            opts._width = Math.max(maxRowWidth, groupOffsetX) + bw;\n            opts._height = groupOffsetY + maxGroupHeightInRow + endPad;\n        } else {\n            var nTraces = traces.size();\n            var oneRowLegend = (combinedItemWidth + bw2 + (nTraces - 1) * itemGap) < opts._maxWidth;\n\n            var maxItemHeightInRow = 0;\n            var offsetX = 0;\n            var offsetY = 0;\n            var rowWidth = 0;\n            traces.each(function(d) {\n                var h = d[0].height;\n                var w = textGap + d[0].width;\n                var next = (oneRowLegend ? w : maxItemWidth) + itemGap;\n\n                if((next + bw + offsetX) > opts._maxWidth) {\n                    maxRowWidth = Math.max(maxRowWidth, rowWidth);\n                    offsetX = 0;\n                    offsetY += maxItemHeightInRow;\n                    opts._height += maxItemHeightInRow;\n                    maxItemHeightInRow = 0;\n                }\n\n                Drawing.setTranslate(this,\n                    titleSize[0] + bw + offsetX,\n                    titleSize[1] + bw + offsetY + h / 2 + itemGap\n                );\n\n                rowWidth = offsetX + w + itemGap;\n                offsetX += next;\n                maxItemHeightInRow = Math.max(maxItemHeightInRow, h);\n            });\n\n            if(oneRowLegend) {\n                opts._width = offsetX + bw2;\n                opts._height = maxItemHeightInRow + endPad;\n            } else {\n                opts._width = Math.max(maxRowWidth, rowWidth) + bw2;\n                opts._height += maxItemHeightInRow + endPad;\n            }\n        }\n    }\n\n    opts._width = Math.ceil(\n        Math.max(\n            opts._width + titleSize[0],\n            opts._titleWidth + 2 * (bw + constants.titlePad)\n        )\n    );\n\n    opts._height = Math.ceil(\n        Math.max(\n            opts._height + titleSize[1],\n            opts._titleHeight + 2 * (bw + constants.itemGap)\n        )\n    );\n\n    opts._effHeight = Math.min(opts._height, opts._maxHeight);\n\n    var edits = gd._context.edits;\n    var isEditable = edits.legendText || edits.legendPosition;\n    traces.each(function(d) {\n        var traceToggle = d3.select(this).select('.legendtoggle');\n        var h = d[0].height;\n        var w = isEditable ? textGap : (toggleRectWidth || (textGap + d[0].width));\n        if(!isVertical) w += itemGap / 2;\n        Drawing.setRect(traceToggle, 0, -h / 2, w, h);\n    });\n}\n\nfunction expandMargin(gd) {\n    var fullLayout = gd._fullLayout;\n    var opts = fullLayout.legend;\n    var xanchor = getXanchor(opts);\n    var yanchor = getYanchor(opts);\n\n    return Plots.autoMargin(gd, 'legend', {\n        x: opts.x,\n        y: opts.y,\n        l: opts._width * (FROM_TL[xanchor]),\n        r: opts._width * (FROM_BR[xanchor]),\n        b: opts._effHeight * (FROM_BR[yanchor]),\n        t: opts._effHeight * (FROM_TL[yanchor])\n    });\n}\n\nfunction getXanchor(opts) {\n    return Lib.isRightAnchor(opts) ? 'right' :\n        Lib.isCenterAnchor(opts) ? 'center' :\n        'left';\n}\n\nfunction getYanchor(opts) {\n    return Lib.isBottomAnchor(opts) ? 'bottom' :\n        Lib.isMiddleAnchor(opts) ? 'middle' :\n        'top';\n}\n"]},"metadata":{},"sourceType":"script"}