{"ast":null,"code":"/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar d3 = require('d3');\n\nvar tinycolor = require('tinycolor2');\n\nvar Registry = require('../../registry');\n\nvar Lib = require('../../lib');\n\nvar Color = require('../../components/color');\n\nvar Drawing = require('../../components/drawing');\n\nvar Plots = require('../plots');\n\nvar Axes = require('../../plots/cartesian/axes');\n\nvar setConvertCartesian = require('../cartesian/set_convert');\n\nvar setConvertPolar = require('./set_convert');\n\nvar doAutoRange = require('../cartesian/autorange').doAutoRange;\n\nvar dragBox = require('../cartesian/dragbox');\n\nvar dragElement = require('../../components/dragelement');\n\nvar Fx = require('../../components/fx');\n\nvar Titles = require('../../components/titles');\n\nvar prepSelect = require('../cartesian/select').prepSelect;\n\nvar selectOnClick = require('../cartesian/select').selectOnClick;\n\nvar clearSelect = require('../cartesian/select').clearSelect;\n\nvar setCursor = require('../../lib/setcursor');\n\nvar clearGlCanvases = require('../../lib/clear_gl_canvases');\n\nvar redrawReglTraces = require('../../plot_api/subroutines').redrawReglTraces;\n\nvar MID_SHIFT = require('../../constants/alignment').MID_SHIFT;\n\nvar constants = require('./constants');\n\nvar helpers = require('./helpers');\n\nvar _ = Lib._;\nvar mod = Lib.mod;\nvar deg2rad = Lib.deg2rad;\nvar rad2deg = Lib.rad2deg;\n\nfunction Polar(gd, id) {\n  this.id = id;\n  this.gd = gd;\n  this._hasClipOnAxisFalse = null;\n  this.vangles = null;\n  this.radialAxisAngle = null;\n  this.traceHash = {};\n  this.layers = {};\n  this.clipPaths = {};\n  this.clipIds = {};\n  this.viewInitial = {};\n  var fullLayout = gd._fullLayout;\n  var clipIdBase = 'clip' + fullLayout._uid + id;\n  this.clipIds.forTraces = clipIdBase + '-for-traces';\n  this.clipPaths.forTraces = fullLayout._clips.append('clipPath').attr('id', this.clipIds.forTraces);\n  this.clipPaths.forTraces.append('path');\n  this.framework = fullLayout._polarlayer.append('g').attr('class', id); // unfortunately, we have to keep track of some axis tick settings\n  // as polar subplots do not implement the 'ticks' editType\n\n  this.radialTickLayout = null;\n  this.angularTickLayout = null;\n}\n\nvar proto = Polar.prototype;\n\nmodule.exports = function createPolar(gd, id) {\n  return new Polar(gd, id);\n};\n\nproto.plot = function (polarCalcData, fullLayout) {\n  var _this = this;\n\n  var polarLayout = fullLayout[_this.id];\n  _this._hasClipOnAxisFalse = false;\n\n  for (var i = 0; i < polarCalcData.length; i++) {\n    var trace = polarCalcData[i][0].trace;\n\n    if (trace.cliponaxis === false) {\n      _this._hasClipOnAxisFalse = true;\n      break;\n    }\n  }\n\n  _this.updateLayers(fullLayout, polarLayout);\n\n  _this.updateLayout(fullLayout, polarLayout);\n\n  Plots.generalUpdatePerTraceModule(_this.gd, _this, polarCalcData, polarLayout);\n\n  _this.updateFx(fullLayout, polarLayout);\n};\n\nproto.updateLayers = function (fullLayout, polarLayout) {\n  var _this = this;\n\n  var layers = _this.layers;\n  var radialLayout = polarLayout.radialaxis;\n  var angularLayout = polarLayout.angularaxis;\n  var layerNames = constants.layerNames;\n  var frontPlotIndex = layerNames.indexOf('frontplot');\n  var layerData = layerNames.slice(0, frontPlotIndex);\n  var isAngularAxisBelowTraces = angularLayout.layer === 'below traces';\n  var isRadialAxisBelowTraces = radialLayout.layer === 'below traces';\n  if (isAngularAxisBelowTraces) layerData.push('angular-line');\n  if (isRadialAxisBelowTraces) layerData.push('radial-line');\n  if (isAngularAxisBelowTraces) layerData.push('angular-axis');\n  if (isRadialAxisBelowTraces) layerData.push('radial-axis');\n  layerData.push('frontplot');\n  if (!isAngularAxisBelowTraces) layerData.push('angular-line');\n  if (!isRadialAxisBelowTraces) layerData.push('radial-line');\n  if (!isAngularAxisBelowTraces) layerData.push('angular-axis');\n  if (!isRadialAxisBelowTraces) layerData.push('radial-axis');\n\n  var join = _this.framework.selectAll('.polarsublayer').data(layerData, String);\n\n  join.enter().append('g').attr('class', function (d) {\n    return 'polarsublayer ' + d;\n  }).each(function (d) {\n    var sel = layers[d] = d3.select(this);\n\n    switch (d) {\n      case 'frontplot':\n        // TODO add option to place in 'backplot' layer??\n        sel.append('g').classed('barlayer', true);\n        sel.append('g').classed('scatterlayer', true);\n        break;\n\n      case 'backplot':\n        sel.append('g').classed('maplayer', true);\n        break;\n\n      case 'plotbg':\n        layers.bg = sel.append('path');\n        break;\n\n      case 'radial-grid':\n        sel.style('fill', 'none');\n        break;\n\n      case 'angular-grid':\n        sel.style('fill', 'none');\n        break;\n\n      case 'radial-line':\n        sel.append('line').style('fill', 'none');\n        break;\n\n      case 'angular-line':\n        sel.append('path').style('fill', 'none');\n        break;\n    }\n  });\n  join.order();\n};\n/* Polar subplots juggle with 6 'axis objects' (!), these are:\n *\n * - polarLayout.radialaxis (aka radialLayout in this file):\n * - polarLayout.angularaxis (aka angularLayout in this file):\n *   used for data -> calcdata conversions (aka d2c) during the calc step\n *\n * - this.radialAxis\n *   extends polarLayout.radialaxis, adds mocked 'domain' and\n *   few other keys in order to reuse Cartesian doAutoRange and the Axes\n *   drawing routines.\n *   used for calcdata -> geometric conversions (aka c2g) during the plot step\n *   + setGeometry setups ax.c2g for given ax.range\n *   + setScale setups ax._m,ax._b for given ax.range\n *\n * - this.angularAxis\n *   extends polarLayout.angularaxis, adds mocked 'range' and 'domain' and\n *   a few other keys in order to reuse the Axes drawing routines.\n *   used for calcdata -> geometric conversions (aka c2g) during the plot step\n *   + setGeometry setups ax.c2g given ax.rotation, ax.direction & ax._categories,\n *                 and mocks ax.range\n *   + setScale setups ax._m,ax._b with that mocked ax.range\n *\n * - this.xaxis\n * - this.yaxis\n *   setup so that polar traces can reuse plot methods of Cartesian traces\n *   which mostly rely on 2pixel methods (e.g ax.c2p)\n */\n\n\nproto.updateLayout = function (fullLayout, polarLayout) {\n  var _this = this;\n\n  var layers = _this.layers;\n  var gs = fullLayout._size; // axis attributes\n\n  var radialLayout = polarLayout.radialaxis;\n  var angularLayout = polarLayout.angularaxis; // layout domains\n\n  var xDomain = polarLayout.domain.x;\n  var yDomain = polarLayout.domain.y; // offsets from paper edge to layout domain box\n\n  _this.xOffset = gs.l + gs.w * xDomain[0];\n  _this.yOffset = gs.t + gs.h * (1 - yDomain[1]); // lengths of the layout domain box\n\n  var xLength = _this.xLength = gs.w * (xDomain[1] - xDomain[0]);\n  var yLength = _this.yLength = gs.h * (yDomain[1] - yDomain[0]); // sector to plot\n\n  var sector = polarLayout.sector;\n  _this.sectorInRad = sector.map(deg2rad);\n  var sectorBBox = _this.sectorBBox = computeSectorBBox(sector);\n  var dxSectorBBox = sectorBBox[2] - sectorBBox[0];\n  var dySectorBBox = sectorBBox[3] - sectorBBox[1]; // aspect ratios\n\n  var arDomain = yLength / xLength;\n  var arSector = Math.abs(dySectorBBox / dxSectorBBox); // actual lengths and domains of subplot box\n\n  var xLength2, yLength2;\n  var xDomain2, yDomain2;\n  var gap;\n\n  if (arDomain > arSector) {\n    xLength2 = xLength;\n    yLength2 = xLength * arSector;\n    gap = (yLength - yLength2) / gs.h / 2;\n    xDomain2 = [xDomain[0], xDomain[1]];\n    yDomain2 = [yDomain[0] + gap, yDomain[1] - gap];\n  } else {\n    xLength2 = yLength / arSector;\n    yLength2 = yLength;\n    gap = (xLength - xLength2) / gs.w / 2;\n    xDomain2 = [xDomain[0] + gap, xDomain[1] - gap];\n    yDomain2 = [yDomain[0], yDomain[1]];\n  }\n\n  _this.xLength2 = xLength2;\n  _this.yLength2 = yLength2;\n  _this.xDomain2 = xDomain2;\n  _this.yDomain2 = yDomain2; // actual offsets from paper edge to the subplot box top-left corner\n\n  var xOffset2 = _this.xOffset2 = gs.l + gs.w * xDomain2[0];\n  var yOffset2 = _this.yOffset2 = gs.t + gs.h * (1 - yDomain2[1]); // circle radius in px\n\n  var radius = _this.radius = xLength2 / dxSectorBBox; // 'inner' radius in px (when polar.hole is set)\n\n  var innerRadius = _this.innerRadius = polarLayout.hole * radius; // circle center position in px\n\n  var cx = _this.cx = xOffset2 - radius * sectorBBox[0];\n  var cy = _this.cy = yOffset2 + radius * sectorBBox[3]; // circle center in the coordinate system of plot area\n\n  var cxx = _this.cxx = cx - xOffset2;\n  var cyy = _this.cyy = cy - yOffset2;\n  _this.radialAxis = _this.mockAxis(fullLayout, polarLayout, radialLayout, {\n    // make this an 'x' axis to make positioning (especially rotation) easier\n    _id: 'x',\n    // convert to 'x' axis equivalent\n    side: {\n      counterclockwise: 'top',\n      clockwise: 'bottom'\n    }[radialLayout.side],\n    // spans length 1 radius\n    domain: [innerRadius / gs.w, radius / gs.w]\n  });\n  _this.angularAxis = _this.mockAxis(fullLayout, polarLayout, angularLayout, {\n    side: 'right',\n    // to get auto nticks right\n    domain: [0, Math.PI],\n    // don't pass through autorange logic\n    autorange: false\n  });\n\n  _this.doAutoRange(fullLayout, polarLayout); // N.B. this sets _this.vangles\n\n\n  _this.updateAngularAxis(fullLayout, polarLayout); // N.B. this sets _this.radialAxisAngle\n\n\n  _this.updateRadialAxis(fullLayout, polarLayout);\n\n  _this.updateRadialAxisTitle(fullLayout, polarLayout);\n\n  _this.xaxis = _this.mockCartesianAxis(fullLayout, polarLayout, {\n    _id: 'x',\n    domain: xDomain2\n  });\n  _this.yaxis = _this.mockCartesianAxis(fullLayout, polarLayout, {\n    _id: 'y',\n    domain: yDomain2\n  });\n\n  var dPath = _this.pathSubplot();\n\n  _this.clipPaths.forTraces.select('path').attr('d', dPath).attr('transform', strTranslate(cxx, cyy));\n\n  layers.frontplot.attr('transform', strTranslate(xOffset2, yOffset2)).call(Drawing.setClipUrl, _this._hasClipOnAxisFalse ? null : _this.clipIds.forTraces, _this.gd);\n  layers.bg.attr('d', dPath).attr('transform', strTranslate(cx, cy)).call(Color.fill, polarLayout.bgcolor);\n};\n\nproto.mockAxis = function (fullLayout, polarLayout, axLayout, opts) {\n  var ax = Lib.extendFlat({}, axLayout, opts);\n  setConvertPolar(ax, polarLayout, fullLayout);\n  return ax;\n};\n\nproto.mockCartesianAxis = function (fullLayout, polarLayout, opts) {\n  var _this = this;\n\n  var axId = opts._id;\n  var ax = Lib.extendFlat({\n    type: 'linear'\n  }, opts);\n  setConvertCartesian(ax, fullLayout);\n  var bboxIndices = {\n    x: [0, 2],\n    y: [1, 3]\n  };\n\n  ax.setRange = function () {\n    var sectorBBox = _this.sectorBBox;\n    var ind = bboxIndices[axId];\n    var rl = _this.radialAxis._rl;\n    var drl = (rl[1] - rl[0]) / (1 - polarLayout.hole);\n    ax.range = [sectorBBox[ind[0]] * drl, sectorBBox[ind[1]] * drl];\n  };\n\n  ax.isPtWithinRange = axId === 'x' ? function (d) {\n    return _this.isPtInside(d);\n  } : function () {\n    return true;\n  };\n  ax.setRange();\n  ax.setScale();\n  return ax;\n};\n\nproto.doAutoRange = function (fullLayout, polarLayout) {\n  var gd = this.gd;\n  var radialAxis = this.radialAxis;\n  var radialLayout = polarLayout.radialaxis;\n  radialAxis.setScale();\n  doAutoRange(gd, radialAxis);\n  var rng = radialAxis.range;\n  radialLayout.range = rng.slice();\n  radialLayout._input.range = rng.slice();\n  radialAxis._rl = [radialAxis.r2l(rng[0], null, 'gregorian'), radialAxis.r2l(rng[1], null, 'gregorian')];\n};\n\nproto.updateRadialAxis = function (fullLayout, polarLayout) {\n  var _this = this;\n\n  var gd = _this.gd;\n  var layers = _this.layers;\n  var radius = _this.radius;\n  var innerRadius = _this.innerRadius;\n  var cx = _this.cx;\n  var cy = _this.cy;\n  var radialLayout = polarLayout.radialaxis;\n  var a0 = mod(polarLayout.sector[0], 360);\n  var ax = _this.radialAxis;\n  var hasRoomForIt = innerRadius < radius;\n\n  _this.fillViewInitialKey('radialaxis.angle', radialLayout.angle);\n\n  _this.fillViewInitialKey('radialaxis.range', ax.range.slice());\n\n  ax.setGeometry(); // rotate auto tick labels by 180 if in quadrant II and III to make them\n  // readable from left-to-right\n  //\n  // TODO try moving deeper in Axes.drawLabels for better results?\n\n  if (ax.tickangle === 'auto' && a0 > 90 && a0 <= 270) {\n    ax.tickangle = 180;\n  } // easier to set rotate angle with custom translate function\n\n\n  var transFn = function transFn(d) {\n    return 'translate(' + (ax.l2p(d.x) + innerRadius) + ',0)';\n  }; // set special grid path function\n\n\n  var gridPathFn = function gridPathFn(d) {\n    return _this.pathArc(ax.r2p(d.x) + innerRadius);\n  };\n\n  var newTickLayout = strTickLayout(radialLayout);\n\n  if (_this.radialTickLayout !== newTickLayout) {\n    layers['radial-axis'].selectAll('.xtick').remove();\n    _this.radialTickLayout = newTickLayout;\n  }\n\n  if (hasRoomForIt) {\n    ax.setScale();\n    var vals = Axes.calcTicks(ax);\n    var valsClipped = Axes.clipEnds(ax, vals);\n    var tickSign = Axes.getTickSigns(ax)[2];\n    Axes.drawTicks(gd, ax, {\n      vals: vals,\n      layer: layers['radial-axis'],\n      path: Axes.makeTickPath(ax, 0, tickSign),\n      transFn: transFn,\n      crisp: false\n    });\n    Axes.drawGrid(gd, ax, {\n      vals: valsClipped,\n      layer: layers['radial-grid'],\n      path: gridPathFn,\n      transFn: Lib.noop,\n      crisp: false\n    });\n    Axes.drawLabels(gd, ax, {\n      vals: vals,\n      layer: layers['radial-axis'],\n      transFn: transFn,\n      labelFns: Axes.makeLabelFns(ax, 0)\n    });\n  } // stash 'actual' radial axis angle for drag handlers (in degrees)\n\n\n  var angle = _this.radialAxisAngle = _this.vangles ? rad2deg(snapToVertexAngle(deg2rad(radialLayout.angle), _this.vangles)) : radialLayout.angle;\n  var tLayer = strTranslate(cx, cy);\n  var tLayer2 = tLayer + strRotate(-angle);\n  updateElement(layers['radial-axis'], hasRoomForIt && (radialLayout.showticklabels || radialLayout.ticks), {\n    transform: tLayer2\n  });\n  updateElement(layers['radial-grid'], hasRoomForIt && radialLayout.showgrid, {\n    transform: tLayer\n  });\n  updateElement(layers['radial-line'].select('line'), hasRoomForIt && radialLayout.showline, {\n    x1: innerRadius,\n    y1: 0,\n    x2: radius,\n    y2: 0,\n    transform: tLayer2\n  }).attr('stroke-width', radialLayout.linewidth).call(Color.stroke, radialLayout.linecolor);\n};\n\nproto.updateRadialAxisTitle = function (fullLayout, polarLayout, _angle) {\n  var _this = this;\n\n  var gd = _this.gd;\n  var radius = _this.radius;\n  var cx = _this.cx;\n  var cy = _this.cy;\n  var radialLayout = polarLayout.radialaxis;\n  var titleClass = _this.id + 'title';\n  var angle = _angle !== undefined ? _angle : _this.radialAxisAngle;\n  var angleRad = deg2rad(angle);\n  var cosa = Math.cos(angleRad);\n  var sina = Math.sin(angleRad);\n  var pad = 0; // Hint: no need to check if there is in fact a title.text set\n  // because if plot is editable, pad needs to be calculated anyways\n  // to properly show placeholder text when title is empty.\n\n  if (radialLayout.title) {\n    var h = Drawing.bBox(_this.layers['radial-axis'].node()).height;\n    var ts = radialLayout.title.font.size;\n    pad = radialLayout.side === 'counterclockwise' ? -h - ts * 0.4 : h + ts * 0.8;\n  }\n\n  _this.layers['radial-axis-title'] = Titles.draw(gd, titleClass, {\n    propContainer: radialLayout,\n    propName: _this.id + '.radialaxis.title',\n    placeholder: _(gd, 'Click to enter radial axis title'),\n    attributes: {\n      x: cx + radius / 2 * cosa + pad * sina,\n      y: cy - radius / 2 * sina + pad * cosa,\n      'text-anchor': 'middle'\n    },\n    transform: {\n      rotate: -angle\n    }\n  });\n};\n\nproto.updateAngularAxis = function (fullLayout, polarLayout) {\n  var _this = this;\n\n  var gd = _this.gd;\n  var layers = _this.layers;\n  var radius = _this.radius;\n  var innerRadius = _this.innerRadius;\n  var cx = _this.cx;\n  var cy = _this.cy;\n  var angularLayout = polarLayout.angularaxis;\n  var ax = _this.angularAxis;\n\n  _this.fillViewInitialKey('angularaxis.rotation', angularLayout.rotation);\n\n  ax.setGeometry();\n  ax.setScale(); // 't'ick to 'g'eometric radians is used all over the place here\n\n  var t2g = function t2g(d) {\n    return ax.t2g(d.x);\n  }; // run rad2deg on tick0 and ditck for thetaunit: 'radians' axes\n\n\n  if (ax.type === 'linear' && ax.thetaunit === 'radians') {\n    ax.tick0 = rad2deg(ax.tick0);\n    ax.dtick = rad2deg(ax.dtick);\n  }\n\n  var _transFn = function _transFn(rad) {\n    return strTranslate(cx + radius * Math.cos(rad), cy - radius * Math.sin(rad));\n  };\n\n  var transFn = function transFn(d) {\n    return _transFn(t2g(d));\n  };\n\n  var transFn2 = function transFn2(d) {\n    var rad = t2g(d);\n    return _transFn(rad) + strRotate(-rad2deg(rad));\n  };\n\n  var gridPathFn = function gridPathFn(d) {\n    var rad = t2g(d);\n    var cosRad = Math.cos(rad);\n    var sinRad = Math.sin(rad);\n    return 'M' + [cx + innerRadius * cosRad, cy - innerRadius * sinRad] + 'L' + [cx + radius * cosRad, cy - radius * sinRad];\n  };\n\n  var out = Axes.makeLabelFns(ax, 0);\n  var labelStandoff = out.labelStandoff;\n  var labelFns = {};\n\n  labelFns.xFn = function (d) {\n    var rad = t2g(d);\n    return Math.cos(rad) * labelStandoff;\n  };\n\n  labelFns.yFn = function (d) {\n    var rad = t2g(d);\n    var ff = Math.sin(rad) > 0 ? 0.2 : 1;\n    return -Math.sin(rad) * (labelStandoff + d.fontSize * ff) + Math.abs(Math.cos(rad)) * (d.fontSize * MID_SHIFT);\n  };\n\n  labelFns.anchorFn = function (d) {\n    var rad = t2g(d);\n    var cos = Math.cos(rad);\n    return Math.abs(cos) < 0.1 ? 'middle' : cos > 0 ? 'start' : 'end';\n  };\n\n  labelFns.heightFn = function (d, a, h) {\n    var rad = t2g(d);\n    return -0.5 * (1 + Math.sin(rad)) * h;\n  };\n\n  var newTickLayout = strTickLayout(angularLayout);\n\n  if (_this.angularTickLayout !== newTickLayout) {\n    layers['angular-axis'].selectAll('.' + ax._id + 'tick').remove();\n    _this.angularTickLayout = newTickLayout;\n  }\n\n  var vals = Axes.calcTicks(ax); // angle of polygon vertices in geometric radians (null means circles)\n  // TODO what to do when ax.period > ax._categories ??\n\n  var vangles;\n\n  if (polarLayout.gridshape === 'linear') {\n    vangles = vals.map(t2g); // ax._vals should be always ordered, make them\n    // always turn counterclockwise for convenience here\n\n    if (Lib.angleDelta(vangles[0], vangles[1]) < 0) {\n      vangles = vangles.slice().reverse();\n    }\n  } else {\n    vangles = null;\n  }\n\n  _this.vangles = vangles; // Use tickval filter for category axes instead of tweaking\n  // the range w.r.t sector, so that sectors that cross 360 can\n  // show all their ticks.\n\n  if (ax.type === 'category') {\n    vals = vals.filter(function (d) {\n      return Lib.isAngleInsideSector(t2g(d), _this.sectorInRad);\n    });\n  }\n\n  if (ax.visible) {\n    var tickSign = ax.ticks === 'inside' ? -1 : 1;\n    var pad = (ax.linewidth || 1) / 2;\n    Axes.drawTicks(gd, ax, {\n      vals: vals,\n      layer: layers['angular-axis'],\n      path: 'M' + tickSign * pad + ',0h' + tickSign * ax.ticklen,\n      transFn: transFn2,\n      crisp: false\n    });\n    Axes.drawGrid(gd, ax, {\n      vals: vals,\n      layer: layers['angular-grid'],\n      path: gridPathFn,\n      transFn: Lib.noop,\n      crisp: false\n    });\n    Axes.drawLabels(gd, ax, {\n      vals: vals,\n      layer: layers['angular-axis'],\n      repositionOnUpdate: true,\n      transFn: transFn,\n      labelFns: labelFns\n    });\n  } // TODO maybe two arcs is better here?\n  // maybe split style attributes between inner and outer angular axes?\n\n\n  updateElement(layers['angular-line'].select('path'), angularLayout.showline, {\n    d: _this.pathSubplot(),\n    transform: strTranslate(cx, cy)\n  }).attr('stroke-width', angularLayout.linewidth).call(Color.stroke, angularLayout.linecolor);\n};\n\nproto.updateFx = function (fullLayout, polarLayout) {\n  if (!this.gd._context.staticPlot) {\n    this.updateAngularDrag(fullLayout);\n    this.updateRadialDrag(fullLayout, polarLayout, 0);\n    this.updateRadialDrag(fullLayout, polarLayout, 1);\n    this.updateMainDrag(fullLayout);\n  }\n};\n\nproto.updateMainDrag = function (fullLayout) {\n  var _this = this;\n\n  var gd = _this.gd;\n  var layers = _this.layers;\n  var zoomlayer = fullLayout._zoomlayer;\n  var MINZOOM = constants.MINZOOM;\n  var OFFEDGE = constants.OFFEDGE;\n  var radius = _this.radius;\n  var innerRadius = _this.innerRadius;\n  var cx = _this.cx;\n  var cy = _this.cy;\n  var cxx = _this.cxx;\n  var cyy = _this.cyy;\n  var sectorInRad = _this.sectorInRad;\n  var vangles = _this.vangles;\n  var radialAxis = _this.radialAxis;\n  var clampTiny = helpers.clampTiny;\n  var findXYatLength = helpers.findXYatLength;\n  var findEnclosingVertexAngles = helpers.findEnclosingVertexAngles;\n  var chw = constants.cornerHalfWidth;\n  var chl = constants.cornerLen / 2;\n  var mainDrag = dragBox.makeDragger(layers, 'path', 'maindrag', 'crosshair');\n  d3.select(mainDrag).attr('d', _this.pathSubplot()).attr('transform', strTranslate(cx, cy));\n  var dragOpts = {\n    element: mainDrag,\n    gd: gd,\n    subplot: _this.id,\n    plotinfo: {\n      id: _this.id,\n      xaxis: _this.xaxis,\n      yaxis: _this.yaxis\n    },\n    xaxes: [_this.xaxis],\n    yaxes: [_this.yaxis]\n  }; // mouse px position at drag start (0), move (1)\n\n  var x0, y0; // radial distance from circle center at drag start (0), move (1)\n\n  var r0, r1; // zoombox persistent quantities\n\n  var path0, dimmed, lum; // zoombox, corners elements\n\n  var zb, corners;\n\n  function norm(x, y) {\n    return Math.sqrt(x * x + y * y);\n  }\n\n  function xy2r(x, y) {\n    return norm(x - cxx, y - cyy);\n  }\n\n  function xy2a(x, y) {\n    return Math.atan2(cyy - y, x - cxx);\n  }\n\n  function ra2xy(r, a) {\n    return [r * Math.cos(a), r * Math.sin(-a)];\n  }\n\n  function pathCorner(r, a) {\n    if (r === 0) return _this.pathSector(2 * chw);\n    var da = chl / r;\n    var am = a - da;\n    var ap = a + da;\n    var rb = Math.max(0, Math.min(r, radius));\n    var rm = rb - chw;\n    var rp = rb + chw;\n    return 'M' + ra2xy(rm, am) + 'A' + [rm, rm] + ' 0,0,0 ' + ra2xy(rm, ap) + 'L' + ra2xy(rp, ap) + 'A' + [rp, rp] + ' 0,0,1 ' + ra2xy(rp, am) + 'Z';\n  } // (x,y) is the pt at middle of the va0 <-> va1 edge\n  //\n  // ... we could eventually add another mode for cursor\n  // angles 'close to' enough to a particular vertex.\n\n\n  function pathCornerForPolygons(r, va0, va1) {\n    if (r === 0) return _this.pathSector(2 * chw);\n    var xy0 = ra2xy(r, va0);\n    var xy1 = ra2xy(r, va1);\n    var x = clampTiny((xy0[0] + xy1[0]) / 2);\n    var y = clampTiny((xy0[1] + xy1[1]) / 2);\n    var innerPts, outerPts;\n\n    if (x && y) {\n      var m = y / x;\n      var mperp = -1 / m;\n      var midPts = findXYatLength(chw, m, x, y);\n      innerPts = findXYatLength(chl, mperp, midPts[0][0], midPts[0][1]);\n      outerPts = findXYatLength(chl, mperp, midPts[1][0], midPts[1][1]);\n    } else {\n      var dx, dy;\n\n      if (y) {\n        // horizontal handles\n        dx = chl;\n        dy = chw;\n      } else {\n        // vertical handles\n        dx = chw;\n        dy = chl;\n      }\n\n      innerPts = [[x - dx, y - dy], [x + dx, y - dy]];\n      outerPts = [[x - dx, y + dy], [x + dx, y + dy]];\n    }\n\n    return 'M' + innerPts.join('L') + 'L' + outerPts.reverse().join('L') + 'Z';\n  }\n\n  function zoomPrep() {\n    r0 = null;\n    r1 = null;\n    path0 = _this.pathSubplot();\n    dimmed = false;\n    var polarLayoutNow = gd._fullLayout[_this.id];\n    lum = tinycolor(polarLayoutNow.bgcolor).getLuminance();\n    zb = dragBox.makeZoombox(zoomlayer, lum, cx, cy, path0);\n    zb.attr('fill-rule', 'evenodd');\n    corners = dragBox.makeCorners(zoomlayer, cx, cy);\n    clearSelect(gd);\n  } // N.B. this sets scoped 'r0' and 'r1'\n  // return true if 'valid' zoom distance, false otherwise\n\n\n  function clampAndSetR0R1(rr0, rr1) {\n    rr1 = Math.max(Math.min(rr1, radius), innerRadius); // starting or ending drag near center (outer edge),\n    // clamps radial distance at origin (at r=radius)\n\n    if (rr0 < OFFEDGE) rr0 = 0;else if (radius - rr0 < OFFEDGE) rr0 = radius;else if (rr1 < OFFEDGE) rr1 = 0;else if (radius - rr1 < OFFEDGE) rr1 = radius; // make sure r0 < r1,\n    // to get correct fill pattern in path1 below\n\n    if (Math.abs(rr1 - rr0) > MINZOOM) {\n      if (rr0 < rr1) {\n        r0 = rr0;\n        r1 = rr1;\n      } else {\n        r0 = rr1;\n        r1 = rr0;\n      }\n\n      return true;\n    } else {\n      r0 = null;\n      r1 = null;\n      return false;\n    }\n  }\n\n  function applyZoomMove(path1, cpath) {\n    path1 = path1 || path0;\n    cpath = cpath || 'M0,0Z';\n    zb.attr('d', path1);\n    corners.attr('d', cpath);\n    dragBox.transitionZoombox(zb, corners, dimmed, lum);\n    dimmed = true;\n    var updateObj = {};\n    computeZoomUpdates(updateObj);\n    gd.emit('plotly_relayouting', updateObj);\n  }\n\n  function zoomMove(dx, dy) {\n    var x1 = x0 + dx;\n    var y1 = y0 + dy;\n    var rr0 = xy2r(x0, y0);\n    var rr1 = Math.min(xy2r(x1, y1), radius);\n    var a0 = xy2a(x0, y0);\n    var path1;\n    var cpath;\n\n    if (clampAndSetR0R1(rr0, rr1)) {\n      path1 = path0 + _this.pathSector(r1);\n      if (r0) path1 += _this.pathSector(r0); // keep 'starting' angle\n\n      cpath = pathCorner(r0, a0) + pathCorner(r1, a0);\n    }\n\n    applyZoomMove(path1, cpath);\n  }\n\n  function findPolygonRadius(x, y, va0, va1) {\n    var xy = helpers.findIntersectionXY(va0, va1, va0, [x - cxx, cyy - y]);\n    return norm(xy[0], xy[1]);\n  }\n\n  function zoomMoveForPolygons(dx, dy) {\n    var x1 = x0 + dx;\n    var y1 = y0 + dy;\n    var a0 = xy2a(x0, y0);\n    var a1 = xy2a(x1, y1);\n    var vangles0 = findEnclosingVertexAngles(a0, vangles);\n    var vangles1 = findEnclosingVertexAngles(a1, vangles);\n    var rr0 = findPolygonRadius(x0, y0, vangles0[0], vangles0[1]);\n    var rr1 = Math.min(findPolygonRadius(x1, y1, vangles1[0], vangles1[1]), radius);\n    var path1;\n    var cpath;\n\n    if (clampAndSetR0R1(rr0, rr1)) {\n      path1 = path0 + _this.pathSector(r1);\n      if (r0) path1 += _this.pathSector(r0); // keep 'starting' angle here too\n\n      cpath = [pathCornerForPolygons(r0, vangles0[0], vangles0[1]), pathCornerForPolygons(r1, vangles0[0], vangles0[1])].join(' ');\n    }\n\n    applyZoomMove(path1, cpath);\n  }\n\n  function zoomDone() {\n    dragBox.removeZoombox(gd);\n    if (r0 === null || r1 === null) return;\n    var updateObj = {};\n    computeZoomUpdates(updateObj);\n    dragBox.showDoubleClickNotifier(gd);\n    Registry.call('_guiRelayout', gd, updateObj);\n  }\n\n  function computeZoomUpdates(update) {\n    var rl = radialAxis._rl;\n    var m = (rl[1] - rl[0]) / (1 - innerRadius / radius) / radius;\n    var newRng = [rl[0] + (r0 - innerRadius) * m, rl[0] + (r1 - innerRadius) * m];\n    update[_this.id + '.radialaxis.range'] = newRng;\n  }\n\n  function zoomClick(numClicks, evt) {\n    var clickMode = gd._fullLayout.clickmode;\n    dragBox.removeZoombox(gd); // TODO double once vs twice logic (autorange vs fixed range)\n\n    if (numClicks === 2) {\n      var updateObj = {};\n\n      for (var k in _this.viewInitial) {\n        updateObj[_this.id + '.' + k] = _this.viewInitial[k];\n      }\n\n      gd.emit('plotly_doubleclick', null);\n      Registry.call('_guiRelayout', gd, updateObj);\n    }\n\n    if (clickMode.indexOf('select') > -1 && numClicks === 1) {\n      selectOnClick(evt, gd, [_this.xaxis], [_this.yaxis], _this.id, dragOpts);\n    }\n\n    if (clickMode.indexOf('event') > -1) {\n      Fx.click(gd, evt, _this.id);\n    }\n  }\n\n  dragOpts.prepFn = function (evt, startX, startY) {\n    var dragModeNow = gd._fullLayout.dragmode;\n    var bbox = mainDrag.getBoundingClientRect();\n    x0 = startX - bbox.left;\n    y0 = startY - bbox.top; // need to offset x/y as bbox center does not\n    // match origin for asymmetric polygons\n\n    if (vangles) {\n      var offset = helpers.findPolygonOffset(radius, sectorInRad[0], sectorInRad[1], vangles);\n      x0 += cxx + offset[0];\n      y0 += cyy + offset[1];\n    }\n\n    switch (dragModeNow) {\n      case 'zoom':\n        if (vangles) {\n          dragOpts.moveFn = zoomMoveForPolygons;\n        } else {\n          dragOpts.moveFn = zoomMove;\n        }\n\n        dragOpts.clickFn = zoomClick;\n        dragOpts.doneFn = zoomDone;\n        zoomPrep(evt, startX, startY);\n        break;\n\n      case 'select':\n      case 'lasso':\n        prepSelect(evt, startX, startY, dragOpts, dragModeNow);\n        break;\n    }\n  };\n\n  mainDrag.onmousemove = function (evt) {\n    Fx.hover(gd, evt, _this.id);\n    gd._fullLayout._lasthover = mainDrag;\n    gd._fullLayout._hoversubplot = _this.id;\n  };\n\n  mainDrag.onmouseout = function (evt) {\n    if (gd._dragging) return;\n    dragElement.unhover(gd, evt);\n  };\n\n  dragElement.init(dragOpts);\n};\n\nproto.updateRadialDrag = function (fullLayout, polarLayout, rngIndex) {\n  var _this = this;\n\n  var gd = _this.gd;\n  var layers = _this.layers;\n  var radius = _this.radius;\n  var innerRadius = _this.innerRadius;\n  var cx = _this.cx;\n  var cy = _this.cy;\n  var radialAxis = _this.radialAxis;\n  var bl = constants.radialDragBoxSize;\n  var bl2 = bl / 2;\n  if (!radialAxis.visible) return;\n  var angle0 = deg2rad(_this.radialAxisAngle);\n  var rl = radialAxis._rl;\n  var rl0 = rl[0];\n  var rl1 = rl[1];\n  var rbase = rl[rngIndex];\n  var m = 0.75 * (rl[1] - rl[0]) / (1 - polarLayout.hole) / radius;\n  var tx, ty, className;\n\n  if (rngIndex) {\n    tx = cx + (radius + bl2) * Math.cos(angle0);\n    ty = cy - (radius + bl2) * Math.sin(angle0);\n    className = 'radialdrag';\n  } else {\n    // the 'inner' box can get called:\n    // - when polar.hole>0\n    // - when polar.sector isn't a full circle\n    // otherwise it is hidden behind the main drag.\n    tx = cx + (innerRadius - bl2) * Math.cos(angle0);\n    ty = cy - (innerRadius - bl2) * Math.sin(angle0);\n    className = 'radialdrag-inner';\n  }\n\n  var radialDrag = dragBox.makeRectDragger(layers, className, 'crosshair', -bl2, -bl2, bl, bl);\n  var dragOpts = {\n    element: radialDrag,\n    gd: gd\n  };\n  updateElement(d3.select(radialDrag), radialAxis.visible && innerRadius < radius, {\n    transform: strTranslate(tx, ty)\n  }); // move function (either rotate or re-range flavor)\n\n  var moveFn2; // rotate angle on done\n\n  var angle1; // re-range range[1] (or range[0]) on done\n\n  var rprime;\n\n  function moveFn(dx, dy) {\n    if (moveFn2) {\n      moveFn2(dx, dy);\n    } else {\n      var dvec = [dx, -dy];\n      var rvec = [Math.cos(angle0), Math.sin(angle0)];\n      var comp = Math.abs(Lib.dot(dvec, rvec) / Math.sqrt(Lib.dot(dvec, dvec))); // mostly perpendicular motions rotate,\n      // mostly parallel motions re-range\n\n      if (!isNaN(comp)) {\n        moveFn2 = comp < 0.5 ? rotateMove : rerangeMove;\n      }\n    }\n\n    var update = {};\n    computeRadialAxisUpdates(update);\n    gd.emit('plotly_relayouting', update);\n  }\n\n  function computeRadialAxisUpdates(update) {\n    if (angle1 !== null) {\n      update[_this.id + '.radialaxis.angle'] = angle1;\n    } else if (rprime !== null) {\n      update[_this.id + '.radialaxis.range[' + rngIndex + ']'] = rprime;\n    }\n  }\n\n  function doneFn() {\n    if (angle1 !== null) {\n      Registry.call('_guiRelayout', gd, _this.id + '.radialaxis.angle', angle1);\n    } else if (rprime !== null) {\n      Registry.call('_guiRelayout', gd, _this.id + '.radialaxis.range[' + rngIndex + ']', rprime);\n    }\n  }\n\n  function rotateMove(dx, dy) {\n    // disable for inner drag boxes\n    if (rngIndex === 0) return;\n    var x1 = tx + dx;\n    var y1 = ty + dy;\n    angle1 = Math.atan2(cy - y1, x1 - cx);\n    if (_this.vangles) angle1 = snapToVertexAngle(angle1, _this.vangles);\n    angle1 = rad2deg(angle1);\n    var transform = strTranslate(cx, cy) + strRotate(-angle1);\n    layers['radial-axis'].attr('transform', transform);\n    layers['radial-line'].select('line').attr('transform', transform);\n    var fullLayoutNow = _this.gd._fullLayout;\n    var polarLayoutNow = fullLayoutNow[_this.id];\n\n    _this.updateRadialAxisTitle(fullLayoutNow, polarLayoutNow, angle1);\n  }\n\n  function rerangeMove(dx, dy) {\n    // project (dx, dy) unto unit radial axis vector\n    var dr = Lib.dot([dx, -dy], [Math.cos(angle0), Math.sin(angle0)]);\n    rprime = rbase - m * dr; // make sure rprime does not change the range[0] -> range[1] sign\n\n    if (m > 0 !== (rngIndex ? rprime > rl0 : rprime < rl1)) {\n      rprime = null;\n      return;\n    }\n\n    var fullLayoutNow = gd._fullLayout;\n    var polarLayoutNow = fullLayoutNow[_this.id]; // update radial range -> update c2g -> update _m,_b\n\n    radialAxis.range[rngIndex] = rprime;\n    radialAxis._rl[rngIndex] = rprime;\n\n    _this.updateRadialAxis(fullLayoutNow, polarLayoutNow);\n\n    _this.xaxis.setRange();\n\n    _this.xaxis.setScale();\n\n    _this.yaxis.setRange();\n\n    _this.yaxis.setScale();\n\n    var hasRegl = false;\n\n    for (var traceType in _this.traceHash) {\n      var moduleCalcData = _this.traceHash[traceType];\n      var moduleCalcDataVisible = Lib.filterVisible(moduleCalcData);\n      var _module = moduleCalcData[0][0].trace._module;\n\n      _module.plot(gd, _this, moduleCalcDataVisible, polarLayoutNow);\n\n      if (Registry.traceIs(traceType, 'gl') && moduleCalcDataVisible.length) hasRegl = true;\n    }\n\n    if (hasRegl) {\n      clearGlCanvases(gd);\n      redrawReglTraces(gd);\n    }\n  }\n\n  dragOpts.prepFn = function () {\n    moveFn2 = null;\n    angle1 = null;\n    rprime = null;\n    dragOpts.moveFn = moveFn;\n    dragOpts.doneFn = doneFn;\n    clearSelect(gd);\n  };\n\n  dragOpts.clampFn = function (dx, dy) {\n    if (Math.sqrt(dx * dx + dy * dy) < constants.MINDRAG) {\n      dx = 0;\n      dy = 0;\n    }\n\n    return [dx, dy];\n  };\n\n  dragElement.init(dragOpts);\n};\n\nproto.updateAngularDrag = function (fullLayout) {\n  var _this = this;\n\n  var gd = _this.gd;\n  var layers = _this.layers;\n  var radius = _this.radius;\n  var angularAxis = _this.angularAxis;\n  var cx = _this.cx;\n  var cy = _this.cy;\n  var cxx = _this.cxx;\n  var cyy = _this.cyy;\n  var dbs = constants.angularDragBoxSize;\n  var angularDrag = dragBox.makeDragger(layers, 'path', 'angulardrag', 'move');\n  var dragOpts = {\n    element: angularDrag,\n    gd: gd\n  };\n  d3.select(angularDrag).attr('d', _this.pathAnnulus(radius, radius + dbs)).attr('transform', strTranslate(cx, cy)).call(setCursor, 'move');\n\n  function xy2a(x, y) {\n    return Math.atan2(cyy + dbs - y, x - cxx - dbs);\n  } // scatter trace, points and textpoints selections\n\n\n  var scatterTraces = layers.frontplot.select('.scatterlayer').selectAll('.trace');\n  var scatterPoints = scatterTraces.selectAll('.point');\n  var scatterTextPoints = scatterTraces.selectAll('.textpoint'); // mouse px position at drag start (0), move (1)\n\n  var x0, y0; // angular axis angle rotation at drag start (0), move (1)\n\n  var rot0, rot1; // induced radial axis rotation (only used on polygon grids)\n\n  var rrot1; // angle about circle center at drag start\n\n  var a0;\n\n  function moveFn(dx, dy) {\n    var fullLayoutNow = _this.gd._fullLayout;\n    var polarLayoutNow = fullLayoutNow[_this.id];\n    var x1 = x0 + dx;\n    var y1 = y0 + dy;\n    var a1 = xy2a(x1, y1);\n    var da = rad2deg(a1 - a0);\n    rot1 = rot0 + da;\n    layers.frontplot.attr('transform', strTranslate(_this.xOffset2, _this.yOffset2) + strRotate([-da, cxx, cyy]));\n\n    if (_this.vangles) {\n      rrot1 = _this.radialAxisAngle + da;\n      var trans = strTranslate(cx, cy) + strRotate(-da);\n      var trans2 = strTranslate(cx, cy) + strRotate(-rrot1);\n      layers.bg.attr('transform', trans);\n      layers['radial-grid'].attr('transform', trans);\n      layers['radial-axis'].attr('transform', trans2);\n      layers['radial-line'].select('line').attr('transform', trans2);\n\n      _this.updateRadialAxisTitle(fullLayoutNow, polarLayoutNow, rrot1);\n    } else {\n      _this.clipPaths.forTraces.select('path').attr('transform', strTranslate(cxx, cyy) + strRotate(da));\n    } // 'un-rotate' marker and text points\n\n\n    scatterPoints.each(function () {\n      var sel = d3.select(this);\n      var xy = Drawing.getTranslate(sel);\n      sel.attr('transform', strTranslate(xy.x, xy.y) + strRotate([da]));\n    });\n    scatterTextPoints.each(function () {\n      var sel = d3.select(this);\n      var tx = sel.select('text');\n      var xy = Drawing.getTranslate(sel); // N.B rotate -> translate ordering matters\n\n      sel.attr('transform', strRotate([da, tx.attr('x'), tx.attr('y')]) + strTranslate(xy.x, xy.y));\n    }); // update rotation -> range -> _m,_b\n\n    angularAxis.rotation = Lib.modHalf(rot1, 360);\n\n    _this.updateAngularAxis(fullLayoutNow, polarLayoutNow);\n\n    if (_this._hasClipOnAxisFalse && !Lib.isFullCircle(_this.sectorInRad)) {\n      scatterTraces.call(Drawing.hideOutsideRangePoints, _this);\n    }\n\n    var hasRegl = false;\n\n    for (var traceType in _this.traceHash) {\n      if (Registry.traceIs(traceType, 'gl')) {\n        var moduleCalcData = _this.traceHash[traceType];\n        var moduleCalcDataVisible = Lib.filterVisible(moduleCalcData);\n        var _module = moduleCalcData[0][0].trace._module;\n\n        _module.plot(gd, _this, moduleCalcDataVisible, polarLayoutNow);\n\n        if (moduleCalcDataVisible.length) hasRegl = true;\n      }\n    }\n\n    if (hasRegl) {\n      clearGlCanvases(gd);\n      redrawReglTraces(gd);\n    }\n\n    var update = {};\n    computeRotationUpdates(update);\n    gd.emit('plotly_relayouting', update);\n  }\n\n  function computeRotationUpdates(updateObj) {\n    updateObj[_this.id + '.angularaxis.rotation'] = rot1;\n\n    if (_this.vangles) {\n      updateObj[_this.id + '.radialaxis.angle'] = rrot1;\n    }\n  }\n\n  function doneFn() {\n    scatterTextPoints.select('text').attr('transform', null);\n    var updateObj = {};\n    computeRotationUpdates(updateObj);\n    Registry.call('_guiRelayout', gd, updateObj);\n  }\n\n  dragOpts.prepFn = function (evt, startX, startY) {\n    var polarLayoutNow = fullLayout[_this.id];\n    rot0 = polarLayoutNow.angularaxis.rotation;\n    var bbox = angularDrag.getBoundingClientRect();\n    x0 = startX - bbox.left;\n    y0 = startY - bbox.top;\n    a0 = xy2a(x0, y0);\n    dragOpts.moveFn = moveFn;\n    dragOpts.doneFn = doneFn;\n    clearSelect(gd);\n  }; // I don't what we should do in this case, skip we now\n\n\n  if (_this.vangles && !Lib.isFullCircle(_this.sectorInRad)) {\n    dragOpts.prepFn = Lib.noop;\n    setCursor(d3.select(angularDrag), null);\n  }\n\n  dragElement.init(dragOpts);\n};\n\nproto.isPtInside = function (d) {\n  var sectorInRad = this.sectorInRad;\n  var vangles = this.vangles;\n  var thetag = this.angularAxis.c2g(d.theta);\n  var radialAxis = this.radialAxis;\n  var r = radialAxis.c2l(d.r);\n  var rl = radialAxis._rl;\n  var fn = vangles ? helpers.isPtInsidePolygon : Lib.isPtInsideSector;\n  return fn(r, thetag, rl, sectorInRad, vangles);\n};\n\nproto.pathArc = function (r) {\n  var sectorInRad = this.sectorInRad;\n  var vangles = this.vangles;\n  var fn = vangles ? helpers.pathPolygon : Lib.pathArc;\n  return fn(r, sectorInRad[0], sectorInRad[1], vangles);\n};\n\nproto.pathSector = function (r) {\n  var sectorInRad = this.sectorInRad;\n  var vangles = this.vangles;\n  var fn = vangles ? helpers.pathPolygon : Lib.pathSector;\n  return fn(r, sectorInRad[0], sectorInRad[1], vangles);\n};\n\nproto.pathAnnulus = function (r0, r1) {\n  var sectorInRad = this.sectorInRad;\n  var vangles = this.vangles;\n  var fn = vangles ? helpers.pathPolygonAnnulus : Lib.pathAnnulus;\n  return fn(r0, r1, sectorInRad[0], sectorInRad[1], vangles);\n};\n\nproto.pathSubplot = function () {\n  var r0 = this.innerRadius;\n  var r1 = this.radius;\n  return r0 ? this.pathAnnulus(r0, r1) : this.pathSector(r1);\n};\n\nproto.fillViewInitialKey = function (key, val) {\n  if (!(key in this.viewInitial)) {\n    this.viewInitial[key] = val;\n  }\n};\n\nfunction strTickLayout(axLayout) {\n  var out = axLayout.ticks + String(axLayout.ticklen) + String(axLayout.showticklabels);\n  if ('side' in axLayout) out += axLayout.side;\n  return out;\n} // Finds the bounding box of a given circle sector,\n// inspired by https://math.stackexchange.com/q/1852703\n//\n// assumes:\n// - sector[0] < sector[1]\n// - counterclockwise rotation\n\n\nfunction computeSectorBBox(sector) {\n  var s0 = sector[0];\n  var s1 = sector[1];\n  var arc = s1 - s0;\n  var a0 = mod(s0, 360);\n  var a1 = a0 + arc;\n  var ax0 = Math.cos(deg2rad(a0));\n  var ay0 = Math.sin(deg2rad(a0));\n  var ax1 = Math.cos(deg2rad(a1));\n  var ay1 = Math.sin(deg2rad(a1));\n  var x0, y0, x1, y1;\n\n  if (a0 <= 90 && a1 >= 90 || a0 > 90 && a1 >= 450) {\n    y1 = 1;\n  } else if (ay0 <= 0 && ay1 <= 0) {\n    y1 = 0;\n  } else {\n    y1 = Math.max(ay0, ay1);\n  }\n\n  if (a0 <= 180 && a1 >= 180 || a0 > 180 && a1 >= 540) {\n    x0 = -1;\n  } else if (ax0 >= 0 && ax1 >= 0) {\n    x0 = 0;\n  } else {\n    x0 = Math.min(ax0, ax1);\n  }\n\n  if (a0 <= 270 && a1 >= 270 || a0 > 270 && a1 >= 630) {\n    y0 = -1;\n  } else if (ay0 >= 0 && ay1 >= 0) {\n    y0 = 0;\n  } else {\n    y0 = Math.min(ay0, ay1);\n  }\n\n  if (a1 >= 360) {\n    x1 = 1;\n  } else if (ax0 <= 0 && ax1 <= 0) {\n    x1 = 0;\n  } else {\n    x1 = Math.max(ax0, ax1);\n  }\n\n  return [x0, y0, x1, y1];\n}\n\nfunction snapToVertexAngle(a, vangles) {\n  var fn = function fn(v) {\n    return Lib.angleDist(a, v);\n  };\n\n  var ind = Lib.findIndexOfMin(vangles, fn);\n  return vangles[ind];\n}\n\nfunction updateElement(sel, showAttr, attrs) {\n  if (showAttr) {\n    sel.attr('display', null);\n    sel.attr(attrs);\n  } else if (sel) {\n    sel.attr('display', 'none');\n  }\n\n  return sel;\n}\n\nfunction strTranslate(x, y) {\n  return 'translate(' + x + ',' + y + ')';\n}\n\nfunction strRotate(angle) {\n  return 'rotate(' + angle + ')';\n}","map":{"version":3,"sources":["/home/raj/go/src/github.com/litmuschaos/litmus/litmus-portal/frontend/node_modules/plotly.js/src/plots/polar/polar.js"],"names":["d3","require","tinycolor","Registry","Lib","Color","Drawing","Plots","Axes","setConvertCartesian","setConvertPolar","doAutoRange","dragBox","dragElement","Fx","Titles","prepSelect","selectOnClick","clearSelect","setCursor","clearGlCanvases","redrawReglTraces","MID_SHIFT","constants","helpers","_","mod","deg2rad","rad2deg","Polar","gd","id","_hasClipOnAxisFalse","vangles","radialAxisAngle","traceHash","layers","clipPaths","clipIds","viewInitial","fullLayout","_fullLayout","clipIdBase","_uid","forTraces","_clips","append","attr","framework","_polarlayer","radialTickLayout","angularTickLayout","proto","prototype","module","exports","createPolar","plot","polarCalcData","_this","polarLayout","i","length","trace","cliponaxis","updateLayers","updateLayout","generalUpdatePerTraceModule","updateFx","radialLayout","radialaxis","angularLayout","angularaxis","layerNames","frontPlotIndex","indexOf","layerData","slice","isAngularAxisBelowTraces","layer","isRadialAxisBelowTraces","push","join","selectAll","data","String","enter","d","each","sel","select","classed","bg","style","order","gs","_size","xDomain","domain","x","yDomain","y","xOffset","l","w","yOffset","t","h","xLength","yLength","sector","sectorInRad","map","sectorBBox","computeSectorBBox","dxSectorBBox","dySectorBBox","arDomain","arSector","Math","abs","xLength2","yLength2","xDomain2","yDomain2","gap","xOffset2","yOffset2","radius","innerRadius","hole","cx","cy","cxx","cyy","radialAxis","mockAxis","_id","side","counterclockwise","clockwise","angularAxis","PI","autorange","updateAngularAxis","updateRadialAxis","updateRadialAxisTitle","xaxis","mockCartesianAxis","yaxis","dPath","pathSubplot","strTranslate","frontplot","call","setClipUrl","fill","bgcolor","axLayout","opts","ax","extendFlat","axId","type","bboxIndices","setRange","ind","rl","_rl","drl","range","isPtWithinRange","isPtInside","setScale","rng","_input","r2l","a0","hasRoomForIt","fillViewInitialKey","angle","setGeometry","tickangle","transFn","l2p","gridPathFn","pathArc","r2p","newTickLayout","strTickLayout","remove","vals","calcTicks","valsClipped","clipEnds","tickSign","getTickSigns","drawTicks","path","makeTickPath","crisp","drawGrid","noop","drawLabels","labelFns","makeLabelFns","snapToVertexAngle","tLayer","tLayer2","strRotate","updateElement","showticklabels","ticks","transform","showgrid","showline","x1","y1","x2","y2","linewidth","stroke","linecolor","_angle","titleClass","undefined","angleRad","cosa","cos","sina","sin","pad","title","bBox","node","height","ts","font","size","draw","propContainer","propName","placeholder","attributes","rotate","rotation","t2g","thetaunit","tick0","dtick","_transFn","rad","transFn2","cosRad","sinRad","out","labelStandoff","xFn","yFn","ff","fontSize","anchorFn","heightFn","a","gridshape","angleDelta","reverse","filter","isAngleInsideSector","visible","ticklen","repositionOnUpdate","_context","staticPlot","updateAngularDrag","updateRadialDrag","updateMainDrag","zoomlayer","_zoomlayer","MINZOOM","OFFEDGE","clampTiny","findXYatLength","findEnclosingVertexAngles","chw","cornerHalfWidth","chl","cornerLen","mainDrag","makeDragger","dragOpts","element","subplot","plotinfo","xaxes","yaxes","x0","y0","r0","r1","path0","dimmed","lum","zb","corners","norm","sqrt","xy2r","xy2a","atan2","ra2xy","r","pathCorner","pathSector","da","am","ap","rb","max","min","rm","rp","pathCornerForPolygons","va0","va1","xy0","xy1","innerPts","outerPts","m","mperp","midPts","dx","dy","zoomPrep","polarLayoutNow","getLuminance","makeZoombox","makeCorners","clampAndSetR0R1","rr0","rr1","applyZoomMove","path1","cpath","transitionZoombox","updateObj","computeZoomUpdates","emit","zoomMove","findPolygonRadius","xy","findIntersectionXY","zoomMoveForPolygons","a1","vangles0","vangles1","zoomDone","removeZoombox","showDoubleClickNotifier","update","newRng","zoomClick","numClicks","evt","clickMode","clickmode","k","click","prepFn","startX","startY","dragModeNow","dragmode","bbox","getBoundingClientRect","left","top","offset","findPolygonOffset","moveFn","clickFn","doneFn","onmousemove","hover","_lasthover","_hoversubplot","onmouseout","_dragging","unhover","init","rngIndex","bl","radialDragBoxSize","bl2","angle0","rl0","rl1","rbase","tx","ty","className","radialDrag","makeRectDragger","moveFn2","angle1","rprime","dvec","rvec","comp","dot","isNaN","rotateMove","rerangeMove","computeRadialAxisUpdates","fullLayoutNow","dr","hasRegl","traceType","moduleCalcData","moduleCalcDataVisible","filterVisible","_module","traceIs","clampFn","MINDRAG","dbs","angularDragBoxSize","angularDrag","pathAnnulus","scatterTraces","scatterPoints","scatterTextPoints","rot0","rot1","rrot1","trans","trans2","getTranslate","modHalf","isFullCircle","hideOutsideRangePoints","computeRotationUpdates","thetag","c2g","theta","c2l","fn","isPtInsidePolygon","isPtInsideSector","pathPolygon","pathPolygonAnnulus","key","val","s0","s1","arc","ax0","ay0","ax1","ay1","v","angleDist","findIndexOfMin","showAttr","attrs"],"mappings":"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","sourcesContent":["/**\n* Copyright 2012-2020, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar d3 = require('d3');\nvar tinycolor = require('tinycolor2');\n\nvar Registry = require('../../registry');\nvar Lib = require('../../lib');\nvar Color = require('../../components/color');\nvar Drawing = require('../../components/drawing');\nvar Plots = require('../plots');\nvar Axes = require('../../plots/cartesian/axes');\nvar setConvertCartesian = require('../cartesian/set_convert');\nvar setConvertPolar = require('./set_convert');\nvar doAutoRange = require('../cartesian/autorange').doAutoRange;\nvar dragBox = require('../cartesian/dragbox');\nvar dragElement = require('../../components/dragelement');\nvar Fx = require('../../components/fx');\nvar Titles = require('../../components/titles');\nvar prepSelect = require('../cartesian/select').prepSelect;\nvar selectOnClick = require('../cartesian/select').selectOnClick;\nvar clearSelect = require('../cartesian/select').clearSelect;\nvar setCursor = require('../../lib/setcursor');\nvar clearGlCanvases = require('../../lib/clear_gl_canvases');\nvar redrawReglTraces = require('../../plot_api/subroutines').redrawReglTraces;\n\nvar MID_SHIFT = require('../../constants/alignment').MID_SHIFT;\nvar constants = require('./constants');\nvar helpers = require('./helpers');\n\nvar _ = Lib._;\nvar mod = Lib.mod;\nvar deg2rad = Lib.deg2rad;\nvar rad2deg = Lib.rad2deg;\n\nfunction Polar(gd, id) {\n    this.id = id;\n    this.gd = gd;\n\n    this._hasClipOnAxisFalse = null;\n    this.vangles = null;\n    this.radialAxisAngle = null;\n    this.traceHash = {};\n    this.layers = {};\n    this.clipPaths = {};\n    this.clipIds = {};\n    this.viewInitial = {};\n\n    var fullLayout = gd._fullLayout;\n    var clipIdBase = 'clip' + fullLayout._uid + id;\n\n    this.clipIds.forTraces = clipIdBase + '-for-traces';\n    this.clipPaths.forTraces = fullLayout._clips.append('clipPath')\n        .attr('id', this.clipIds.forTraces);\n    this.clipPaths.forTraces.append('path');\n\n    this.framework = fullLayout._polarlayer.append('g')\n        .attr('class', id);\n\n    // unfortunately, we have to keep track of some axis tick settings\n    // as polar subplots do not implement the 'ticks' editType\n    this.radialTickLayout = null;\n    this.angularTickLayout = null;\n}\n\nvar proto = Polar.prototype;\n\nmodule.exports = function createPolar(gd, id) {\n    return new Polar(gd, id);\n};\n\nproto.plot = function(polarCalcData, fullLayout) {\n    var _this = this;\n    var polarLayout = fullLayout[_this.id];\n\n    _this._hasClipOnAxisFalse = false;\n    for(var i = 0; i < polarCalcData.length; i++) {\n        var trace = polarCalcData[i][0].trace;\n        if(trace.cliponaxis === false) {\n            _this._hasClipOnAxisFalse = true;\n            break;\n        }\n    }\n\n    _this.updateLayers(fullLayout, polarLayout);\n    _this.updateLayout(fullLayout, polarLayout);\n    Plots.generalUpdatePerTraceModule(_this.gd, _this, polarCalcData, polarLayout);\n    _this.updateFx(fullLayout, polarLayout);\n};\n\nproto.updateLayers = function(fullLayout, polarLayout) {\n    var _this = this;\n    var layers = _this.layers;\n    var radialLayout = polarLayout.radialaxis;\n    var angularLayout = polarLayout.angularaxis;\n    var layerNames = constants.layerNames;\n\n    var frontPlotIndex = layerNames.indexOf('frontplot');\n    var layerData = layerNames.slice(0, frontPlotIndex);\n    var isAngularAxisBelowTraces = angularLayout.layer === 'below traces';\n    var isRadialAxisBelowTraces = radialLayout.layer === 'below traces';\n\n    if(isAngularAxisBelowTraces) layerData.push('angular-line');\n    if(isRadialAxisBelowTraces) layerData.push('radial-line');\n    if(isAngularAxisBelowTraces) layerData.push('angular-axis');\n    if(isRadialAxisBelowTraces) layerData.push('radial-axis');\n\n    layerData.push('frontplot');\n\n    if(!isAngularAxisBelowTraces) layerData.push('angular-line');\n    if(!isRadialAxisBelowTraces) layerData.push('radial-line');\n    if(!isAngularAxisBelowTraces) layerData.push('angular-axis');\n    if(!isRadialAxisBelowTraces) layerData.push('radial-axis');\n\n    var join = _this.framework.selectAll('.polarsublayer')\n        .data(layerData, String);\n\n    join.enter().append('g')\n        .attr('class', function(d) { return 'polarsublayer ' + d;})\n        .each(function(d) {\n            var sel = layers[d] = d3.select(this);\n\n            switch(d) {\n                case 'frontplot':\n                    // TODO add option to place in 'backplot' layer??\n                    sel.append('g').classed('barlayer', true);\n                    sel.append('g').classed('scatterlayer', true);\n                    break;\n                case 'backplot':\n                    sel.append('g').classed('maplayer', true);\n                    break;\n                case 'plotbg':\n                    layers.bg = sel.append('path');\n                    break;\n                case 'radial-grid':\n                    sel.style('fill', 'none');\n                    break;\n                case 'angular-grid':\n                    sel.style('fill', 'none');\n                    break;\n                case 'radial-line':\n                    sel.append('line').style('fill', 'none');\n                    break;\n                case 'angular-line':\n                    sel.append('path').style('fill', 'none');\n                    break;\n            }\n        });\n\n    join.order();\n};\n\n/* Polar subplots juggle with 6 'axis objects' (!), these are:\n *\n * - polarLayout.radialaxis (aka radialLayout in this file):\n * - polarLayout.angularaxis (aka angularLayout in this file):\n *   used for data -> calcdata conversions (aka d2c) during the calc step\n *\n * - this.radialAxis\n *   extends polarLayout.radialaxis, adds mocked 'domain' and\n *   few other keys in order to reuse Cartesian doAutoRange and the Axes\n *   drawing routines.\n *   used for calcdata -> geometric conversions (aka c2g) during the plot step\n *   + setGeometry setups ax.c2g for given ax.range\n *   + setScale setups ax._m,ax._b for given ax.range\n *\n * - this.angularAxis\n *   extends polarLayout.angularaxis, adds mocked 'range' and 'domain' and\n *   a few other keys in order to reuse the Axes drawing routines.\n *   used for calcdata -> geometric conversions (aka c2g) during the plot step\n *   + setGeometry setups ax.c2g given ax.rotation, ax.direction & ax._categories,\n *                 and mocks ax.range\n *   + setScale setups ax._m,ax._b with that mocked ax.range\n *\n * - this.xaxis\n * - this.yaxis\n *   setup so that polar traces can reuse plot methods of Cartesian traces\n *   which mostly rely on 2pixel methods (e.g ax.c2p)\n */\nproto.updateLayout = function(fullLayout, polarLayout) {\n    var _this = this;\n    var layers = _this.layers;\n    var gs = fullLayout._size;\n\n    // axis attributes\n    var radialLayout = polarLayout.radialaxis;\n    var angularLayout = polarLayout.angularaxis;\n    // layout domains\n    var xDomain = polarLayout.domain.x;\n    var yDomain = polarLayout.domain.y;\n    // offsets from paper edge to layout domain box\n    _this.xOffset = gs.l + gs.w * xDomain[0];\n    _this.yOffset = gs.t + gs.h * (1 - yDomain[1]);\n    // lengths of the layout domain box\n    var xLength = _this.xLength = gs.w * (xDomain[1] - xDomain[0]);\n    var yLength = _this.yLength = gs.h * (yDomain[1] - yDomain[0]);\n    // sector to plot\n    var sector = polarLayout.sector;\n    _this.sectorInRad = sector.map(deg2rad);\n    var sectorBBox = _this.sectorBBox = computeSectorBBox(sector);\n    var dxSectorBBox = sectorBBox[2] - sectorBBox[0];\n    var dySectorBBox = sectorBBox[3] - sectorBBox[1];\n    // aspect ratios\n    var arDomain = yLength / xLength;\n    var arSector = Math.abs(dySectorBBox / dxSectorBBox);\n    // actual lengths and domains of subplot box\n    var xLength2, yLength2;\n    var xDomain2, yDomain2;\n    var gap;\n    if(arDomain > arSector) {\n        xLength2 = xLength;\n        yLength2 = xLength * arSector;\n        gap = (yLength - yLength2) / gs.h / 2;\n        xDomain2 = [xDomain[0], xDomain[1]];\n        yDomain2 = [yDomain[0] + gap, yDomain[1] - gap];\n    } else {\n        xLength2 = yLength / arSector;\n        yLength2 = yLength;\n        gap = (xLength - xLength2) / gs.w / 2;\n        xDomain2 = [xDomain[0] + gap, xDomain[1] - gap];\n        yDomain2 = [yDomain[0], yDomain[1]];\n    }\n    _this.xLength2 = xLength2;\n    _this.yLength2 = yLength2;\n    _this.xDomain2 = xDomain2;\n    _this.yDomain2 = yDomain2;\n    // actual offsets from paper edge to the subplot box top-left corner\n    var xOffset2 = _this.xOffset2 = gs.l + gs.w * xDomain2[0];\n    var yOffset2 = _this.yOffset2 = gs.t + gs.h * (1 - yDomain2[1]);\n    // circle radius in px\n    var radius = _this.radius = xLength2 / dxSectorBBox;\n    // 'inner' radius in px (when polar.hole is set)\n    var innerRadius = _this.innerRadius = polarLayout.hole * radius;\n    // circle center position in px\n    var cx = _this.cx = xOffset2 - radius * sectorBBox[0];\n    var cy = _this.cy = yOffset2 + radius * sectorBBox[3];\n    // circle center in the coordinate system of plot area\n    var cxx = _this.cxx = cx - xOffset2;\n    var cyy = _this.cyy = cy - yOffset2;\n\n    _this.radialAxis = _this.mockAxis(fullLayout, polarLayout, radialLayout, {\n        // make this an 'x' axis to make positioning (especially rotation) easier\n        _id: 'x',\n        // convert to 'x' axis equivalent\n        side: {\n            counterclockwise: 'top',\n            clockwise: 'bottom'\n        }[radialLayout.side],\n        // spans length 1 radius\n        domain: [innerRadius / gs.w, radius / gs.w]\n    });\n\n    _this.angularAxis = _this.mockAxis(fullLayout, polarLayout, angularLayout, {\n        side: 'right',\n        // to get auto nticks right\n        domain: [0, Math.PI],\n        // don't pass through autorange logic\n        autorange: false\n    });\n\n    _this.doAutoRange(fullLayout, polarLayout);\n    // N.B. this sets _this.vangles\n    _this.updateAngularAxis(fullLayout, polarLayout);\n    // N.B. this sets _this.radialAxisAngle\n    _this.updateRadialAxis(fullLayout, polarLayout);\n    _this.updateRadialAxisTitle(fullLayout, polarLayout);\n\n    _this.xaxis = _this.mockCartesianAxis(fullLayout, polarLayout, {\n        _id: 'x',\n        domain: xDomain2\n    });\n\n    _this.yaxis = _this.mockCartesianAxis(fullLayout, polarLayout, {\n        _id: 'y',\n        domain: yDomain2\n    });\n\n    var dPath = _this.pathSubplot();\n\n    _this.clipPaths.forTraces.select('path')\n        .attr('d', dPath)\n        .attr('transform', strTranslate(cxx, cyy));\n\n    layers.frontplot\n        .attr('transform', strTranslate(xOffset2, yOffset2))\n        .call(Drawing.setClipUrl, _this._hasClipOnAxisFalse ? null : _this.clipIds.forTraces, _this.gd);\n\n    layers.bg\n        .attr('d', dPath)\n        .attr('transform', strTranslate(cx, cy))\n        .call(Color.fill, polarLayout.bgcolor);\n};\n\nproto.mockAxis = function(fullLayout, polarLayout, axLayout, opts) {\n    var ax = Lib.extendFlat({}, axLayout, opts);\n    setConvertPolar(ax, polarLayout, fullLayout);\n    return ax;\n};\n\nproto.mockCartesianAxis = function(fullLayout, polarLayout, opts) {\n    var _this = this;\n    var axId = opts._id;\n\n    var ax = Lib.extendFlat({type: 'linear'}, opts);\n    setConvertCartesian(ax, fullLayout);\n\n    var bboxIndices = {\n        x: [0, 2],\n        y: [1, 3]\n    };\n\n    ax.setRange = function() {\n        var sectorBBox = _this.sectorBBox;\n        var ind = bboxIndices[axId];\n        var rl = _this.radialAxis._rl;\n        var drl = (rl[1] - rl[0]) / (1 - polarLayout.hole);\n        ax.range = [sectorBBox[ind[0]] * drl, sectorBBox[ind[1]] * drl];\n    };\n\n    ax.isPtWithinRange = axId === 'x' ?\n        function(d) { return _this.isPtInside(d); } :\n        function() { return true; };\n\n    ax.setRange();\n    ax.setScale();\n    return ax;\n};\n\nproto.doAutoRange = function(fullLayout, polarLayout) {\n    var gd = this.gd;\n    var radialAxis = this.radialAxis;\n    var radialLayout = polarLayout.radialaxis;\n\n    radialAxis.setScale();\n    doAutoRange(gd, radialAxis);\n\n    var rng = radialAxis.range;\n    radialLayout.range = rng.slice();\n    radialLayout._input.range = rng.slice();\n\n    radialAxis._rl = [\n        radialAxis.r2l(rng[0], null, 'gregorian'),\n        radialAxis.r2l(rng[1], null, 'gregorian')\n    ];\n};\n\nproto.updateRadialAxis = function(fullLayout, polarLayout) {\n    var _this = this;\n    var gd = _this.gd;\n    var layers = _this.layers;\n    var radius = _this.radius;\n    var innerRadius = _this.innerRadius;\n    var cx = _this.cx;\n    var cy = _this.cy;\n    var radialLayout = polarLayout.radialaxis;\n    var a0 = mod(polarLayout.sector[0], 360);\n    var ax = _this.radialAxis;\n    var hasRoomForIt = innerRadius < radius;\n\n    _this.fillViewInitialKey('radialaxis.angle', radialLayout.angle);\n    _this.fillViewInitialKey('radialaxis.range', ax.range.slice());\n\n    ax.setGeometry();\n\n    // rotate auto tick labels by 180 if in quadrant II and III to make them\n    // readable from left-to-right\n    //\n    // TODO try moving deeper in Axes.drawLabels for better results?\n    if(ax.tickangle === 'auto' && (a0 > 90 && a0 <= 270)) {\n        ax.tickangle = 180;\n    }\n\n    // easier to set rotate angle with custom translate function\n    var transFn = function(d) {\n        return 'translate(' + (ax.l2p(d.x) + innerRadius) + ',0)';\n    };\n\n    // set special grid path function\n    var gridPathFn = function(d) {\n        return _this.pathArc(ax.r2p(d.x) + innerRadius);\n    };\n\n    var newTickLayout = strTickLayout(radialLayout);\n    if(_this.radialTickLayout !== newTickLayout) {\n        layers['radial-axis'].selectAll('.xtick').remove();\n        _this.radialTickLayout = newTickLayout;\n    }\n\n    if(hasRoomForIt) {\n        ax.setScale();\n\n        var vals = Axes.calcTicks(ax);\n        var valsClipped = Axes.clipEnds(ax, vals);\n        var tickSign = Axes.getTickSigns(ax)[2];\n\n        Axes.drawTicks(gd, ax, {\n            vals: vals,\n            layer: layers['radial-axis'],\n            path: Axes.makeTickPath(ax, 0, tickSign),\n            transFn: transFn,\n            crisp: false\n        });\n\n        Axes.drawGrid(gd, ax, {\n            vals: valsClipped,\n            layer: layers['radial-grid'],\n            path: gridPathFn,\n            transFn: Lib.noop,\n            crisp: false\n        });\n\n        Axes.drawLabels(gd, ax, {\n            vals: vals,\n            layer: layers['radial-axis'],\n            transFn: transFn,\n            labelFns: Axes.makeLabelFns(ax, 0)\n        });\n    }\n\n    // stash 'actual' radial axis angle for drag handlers (in degrees)\n    var angle = _this.radialAxisAngle = _this.vangles ?\n        rad2deg(snapToVertexAngle(deg2rad(radialLayout.angle), _this.vangles)) :\n        radialLayout.angle;\n\n    var tLayer = strTranslate(cx, cy);\n    var tLayer2 = tLayer + strRotate(-angle);\n\n    updateElement(\n        layers['radial-axis'],\n        hasRoomForIt && (radialLayout.showticklabels || radialLayout.ticks),\n        {transform: tLayer2}\n    );\n\n    updateElement(\n        layers['radial-grid'],\n        hasRoomForIt && radialLayout.showgrid,\n        {transform: tLayer}\n    );\n\n    updateElement(\n        layers['radial-line'].select('line'),\n        hasRoomForIt && radialLayout.showline,\n        {\n            x1: innerRadius,\n            y1: 0,\n            x2: radius,\n            y2: 0,\n            transform: tLayer2\n        }\n    )\n    .attr('stroke-width', radialLayout.linewidth)\n    .call(Color.stroke, radialLayout.linecolor);\n};\n\nproto.updateRadialAxisTitle = function(fullLayout, polarLayout, _angle) {\n    var _this = this;\n    var gd = _this.gd;\n    var radius = _this.radius;\n    var cx = _this.cx;\n    var cy = _this.cy;\n    var radialLayout = polarLayout.radialaxis;\n    var titleClass = _this.id + 'title';\n\n    var angle = _angle !== undefined ? _angle : _this.radialAxisAngle;\n    var angleRad = deg2rad(angle);\n    var cosa = Math.cos(angleRad);\n    var sina = Math.sin(angleRad);\n\n    var pad = 0;\n\n    // Hint: no need to check if there is in fact a title.text set\n    // because if plot is editable, pad needs to be calculated anyways\n    // to properly show placeholder text when title is empty.\n    if(radialLayout.title) {\n        var h = Drawing.bBox(_this.layers['radial-axis'].node()).height;\n        var ts = radialLayout.title.font.size;\n        pad = radialLayout.side === 'counterclockwise' ?\n            -h - ts * 0.4 :\n            h + ts * 0.8;\n    }\n\n    _this.layers['radial-axis-title'] = Titles.draw(gd, titleClass, {\n        propContainer: radialLayout,\n        propName: _this.id + '.radialaxis.title',\n        placeholder: _(gd, 'Click to enter radial axis title'),\n        attributes: {\n            x: cx + (radius / 2) * cosa + pad * sina,\n            y: cy - (radius / 2) * sina + pad * cosa,\n            'text-anchor': 'middle'\n        },\n        transform: {rotate: -angle}\n    });\n};\n\nproto.updateAngularAxis = function(fullLayout, polarLayout) {\n    var _this = this;\n    var gd = _this.gd;\n    var layers = _this.layers;\n    var radius = _this.radius;\n    var innerRadius = _this.innerRadius;\n    var cx = _this.cx;\n    var cy = _this.cy;\n    var angularLayout = polarLayout.angularaxis;\n    var ax = _this.angularAxis;\n\n    _this.fillViewInitialKey('angularaxis.rotation', angularLayout.rotation);\n\n    ax.setGeometry();\n    ax.setScale();\n\n    // 't'ick to 'g'eometric radians is used all over the place here\n    var t2g = function(d) { return ax.t2g(d.x); };\n\n    // run rad2deg on tick0 and ditck for thetaunit: 'radians' axes\n    if(ax.type === 'linear' && ax.thetaunit === 'radians') {\n        ax.tick0 = rad2deg(ax.tick0);\n        ax.dtick = rad2deg(ax.dtick);\n    }\n\n    var _transFn = function(rad) {\n        return strTranslate(cx + radius * Math.cos(rad), cy - radius * Math.sin(rad));\n    };\n\n    var transFn = function(d) {\n        return _transFn(t2g(d));\n    };\n\n    var transFn2 = function(d) {\n        var rad = t2g(d);\n        return _transFn(rad) + strRotate(-rad2deg(rad));\n    };\n\n    var gridPathFn = function(d) {\n        var rad = t2g(d);\n        var cosRad = Math.cos(rad);\n        var sinRad = Math.sin(rad);\n        return 'M' + [cx + innerRadius * cosRad, cy - innerRadius * sinRad] +\n            'L' + [cx + radius * cosRad, cy - radius * sinRad];\n    };\n\n    var out = Axes.makeLabelFns(ax, 0);\n    var labelStandoff = out.labelStandoff;\n    var labelFns = {};\n\n    labelFns.xFn = function(d) {\n        var rad = t2g(d);\n        return Math.cos(rad) * labelStandoff;\n    };\n\n    labelFns.yFn = function(d) {\n        var rad = t2g(d);\n        var ff = Math.sin(rad) > 0 ? 0.2 : 1;\n        return -Math.sin(rad) * (labelStandoff + d.fontSize * ff) +\n            Math.abs(Math.cos(rad)) * (d.fontSize * MID_SHIFT);\n    };\n\n    labelFns.anchorFn = function(d) {\n        var rad = t2g(d);\n        var cos = Math.cos(rad);\n        return Math.abs(cos) < 0.1 ?\n            'middle' :\n            (cos > 0 ? 'start' : 'end');\n    };\n\n    labelFns.heightFn = function(d, a, h) {\n        var rad = t2g(d);\n        return -0.5 * (1 + Math.sin(rad)) * h;\n    };\n\n    var newTickLayout = strTickLayout(angularLayout);\n    if(_this.angularTickLayout !== newTickLayout) {\n        layers['angular-axis'].selectAll('.' + ax._id + 'tick').remove();\n        _this.angularTickLayout = newTickLayout;\n    }\n\n    var vals = Axes.calcTicks(ax);\n\n    // angle of polygon vertices in geometric radians (null means circles)\n    // TODO what to do when ax.period > ax._categories ??\n    var vangles;\n    if(polarLayout.gridshape === 'linear') {\n        vangles = vals.map(t2g);\n\n        // ax._vals should be always ordered, make them\n        // always turn counterclockwise for convenience here\n        if(Lib.angleDelta(vangles[0], vangles[1]) < 0) {\n            vangles = vangles.slice().reverse();\n        }\n    } else {\n        vangles = null;\n    }\n    _this.vangles = vangles;\n\n    // Use tickval filter for category axes instead of tweaking\n    // the range w.r.t sector, so that sectors that cross 360 can\n    // show all their ticks.\n    if(ax.type === 'category') {\n        vals = vals.filter(function(d) {\n            return Lib.isAngleInsideSector(t2g(d), _this.sectorInRad);\n        });\n    }\n\n    if(ax.visible) {\n        var tickSign = ax.ticks === 'inside' ? -1 : 1;\n        var pad = (ax.linewidth || 1) / 2;\n\n        Axes.drawTicks(gd, ax, {\n            vals: vals,\n            layer: layers['angular-axis'],\n            path: 'M' + (tickSign * pad) + ',0h' + (tickSign * ax.ticklen),\n            transFn: transFn2,\n            crisp: false\n        });\n\n        Axes.drawGrid(gd, ax, {\n            vals: vals,\n            layer: layers['angular-grid'],\n            path: gridPathFn,\n            transFn: Lib.noop,\n            crisp: false\n        });\n\n        Axes.drawLabels(gd, ax, {\n            vals: vals,\n            layer: layers['angular-axis'],\n            repositionOnUpdate: true,\n            transFn: transFn,\n            labelFns: labelFns\n        });\n    }\n\n    // TODO maybe two arcs is better here?\n    // maybe split style attributes between inner and outer angular axes?\n\n    updateElement(layers['angular-line'].select('path'), angularLayout.showline, {\n        d: _this.pathSubplot(),\n        transform: strTranslate(cx, cy)\n    })\n    .attr('stroke-width', angularLayout.linewidth)\n    .call(Color.stroke, angularLayout.linecolor);\n};\n\nproto.updateFx = function(fullLayout, polarLayout) {\n    if(!this.gd._context.staticPlot) {\n        this.updateAngularDrag(fullLayout);\n        this.updateRadialDrag(fullLayout, polarLayout, 0);\n        this.updateRadialDrag(fullLayout, polarLayout, 1);\n        this.updateMainDrag(fullLayout);\n    }\n};\n\nproto.updateMainDrag = function(fullLayout) {\n    var _this = this;\n    var gd = _this.gd;\n    var layers = _this.layers;\n    var zoomlayer = fullLayout._zoomlayer;\n    var MINZOOM = constants.MINZOOM;\n    var OFFEDGE = constants.OFFEDGE;\n    var radius = _this.radius;\n    var innerRadius = _this.innerRadius;\n    var cx = _this.cx;\n    var cy = _this.cy;\n    var cxx = _this.cxx;\n    var cyy = _this.cyy;\n    var sectorInRad = _this.sectorInRad;\n    var vangles = _this.vangles;\n    var radialAxis = _this.radialAxis;\n    var clampTiny = helpers.clampTiny;\n    var findXYatLength = helpers.findXYatLength;\n    var findEnclosingVertexAngles = helpers.findEnclosingVertexAngles;\n    var chw = constants.cornerHalfWidth;\n    var chl = constants.cornerLen / 2;\n\n    var mainDrag = dragBox.makeDragger(layers, 'path', 'maindrag', 'crosshair');\n\n    d3.select(mainDrag)\n        .attr('d', _this.pathSubplot())\n        .attr('transform', strTranslate(cx, cy));\n\n    var dragOpts = {\n        element: mainDrag,\n        gd: gd,\n        subplot: _this.id,\n        plotinfo: {\n            id: _this.id,\n            xaxis: _this.xaxis,\n            yaxis: _this.yaxis\n        },\n        xaxes: [_this.xaxis],\n        yaxes: [_this.yaxis]\n    };\n\n    // mouse px position at drag start (0), move (1)\n    var x0, y0;\n    // radial distance from circle center at drag start (0), move (1)\n    var r0, r1;\n    // zoombox persistent quantities\n    var path0, dimmed, lum;\n    // zoombox, corners elements\n    var zb, corners;\n\n    function norm(x, y) {\n        return Math.sqrt(x * x + y * y);\n    }\n\n    function xy2r(x, y) {\n        return norm(x - cxx, y - cyy);\n    }\n\n    function xy2a(x, y) {\n        return Math.atan2(cyy - y, x - cxx);\n    }\n\n    function ra2xy(r, a) {\n        return [r * Math.cos(a), r * Math.sin(-a)];\n    }\n\n    function pathCorner(r, a) {\n        if(r === 0) return _this.pathSector(2 * chw);\n\n        var da = chl / r;\n        var am = a - da;\n        var ap = a + da;\n        var rb = Math.max(0, Math.min(r, radius));\n        var rm = rb - chw;\n        var rp = rb + chw;\n\n        return 'M' + ra2xy(rm, am) +\n            'A' + [rm, rm] + ' 0,0,0 ' + ra2xy(rm, ap) +\n            'L' + ra2xy(rp, ap) +\n            'A' + [rp, rp] + ' 0,0,1 ' + ra2xy(rp, am) +\n            'Z';\n    }\n\n    // (x,y) is the pt at middle of the va0 <-> va1 edge\n    //\n    // ... we could eventually add another mode for cursor\n    // angles 'close to' enough to a particular vertex.\n    function pathCornerForPolygons(r, va0, va1) {\n        if(r === 0) return _this.pathSector(2 * chw);\n\n        var xy0 = ra2xy(r, va0);\n        var xy1 = ra2xy(r, va1);\n        var x = clampTiny((xy0[0] + xy1[0]) / 2);\n        var y = clampTiny((xy0[1] + xy1[1]) / 2);\n        var innerPts, outerPts;\n\n        if(x && y) {\n            var m = y / x;\n            var mperp = -1 / m;\n            var midPts = findXYatLength(chw, m, x, y);\n            innerPts = findXYatLength(chl, mperp, midPts[0][0], midPts[0][1]);\n            outerPts = findXYatLength(chl, mperp, midPts[1][0], midPts[1][1]);\n        } else {\n            var dx, dy;\n            if(y) {\n                // horizontal handles\n                dx = chl;\n                dy = chw;\n            } else {\n                // vertical handles\n                dx = chw;\n                dy = chl;\n            }\n            innerPts = [[x - dx, y - dy], [x + dx, y - dy]];\n            outerPts = [[x - dx, y + dy], [x + dx, y + dy]];\n        }\n\n        return 'M' + innerPts.join('L') +\n            'L' + outerPts.reverse().join('L') + 'Z';\n    }\n\n    function zoomPrep() {\n        r0 = null;\n        r1 = null;\n        path0 = _this.pathSubplot();\n        dimmed = false;\n\n        var polarLayoutNow = gd._fullLayout[_this.id];\n        lum = tinycolor(polarLayoutNow.bgcolor).getLuminance();\n\n        zb = dragBox.makeZoombox(zoomlayer, lum, cx, cy, path0);\n        zb.attr('fill-rule', 'evenodd');\n        corners = dragBox.makeCorners(zoomlayer, cx, cy);\n        clearSelect(gd);\n    }\n\n    // N.B. this sets scoped 'r0' and 'r1'\n    // return true if 'valid' zoom distance, false otherwise\n    function clampAndSetR0R1(rr0, rr1) {\n        rr1 = Math.max(Math.min(rr1, radius), innerRadius);\n\n        // starting or ending drag near center (outer edge),\n        // clamps radial distance at origin (at r=radius)\n        if(rr0 < OFFEDGE) rr0 = 0;\n        else if((radius - rr0) < OFFEDGE) rr0 = radius;\n        else if(rr1 < OFFEDGE) rr1 = 0;\n        else if((radius - rr1) < OFFEDGE) rr1 = radius;\n\n        // make sure r0 < r1,\n        // to get correct fill pattern in path1 below\n        if(Math.abs(rr1 - rr0) > MINZOOM) {\n            if(rr0 < rr1) {\n                r0 = rr0;\n                r1 = rr1;\n            } else {\n                r0 = rr1;\n                r1 = rr0;\n            }\n            return true;\n        } else {\n            r0 = null;\n            r1 = null;\n            return false;\n        }\n    }\n\n    function applyZoomMove(path1, cpath) {\n        path1 = path1 || path0;\n        cpath = cpath || 'M0,0Z';\n\n        zb.attr('d', path1);\n        corners.attr('d', cpath);\n        dragBox.transitionZoombox(zb, corners, dimmed, lum);\n        dimmed = true;\n\n        var updateObj = {};\n        computeZoomUpdates(updateObj);\n        gd.emit('plotly_relayouting', updateObj);\n    }\n\n    function zoomMove(dx, dy) {\n        var x1 = x0 + dx;\n        var y1 = y0 + dy;\n        var rr0 = xy2r(x0, y0);\n        var rr1 = Math.min(xy2r(x1, y1), radius);\n        var a0 = xy2a(x0, y0);\n        var path1;\n        var cpath;\n\n        if(clampAndSetR0R1(rr0, rr1)) {\n            path1 = path0 + _this.pathSector(r1);\n            if(r0) path1 += _this.pathSector(r0);\n            // keep 'starting' angle\n            cpath = pathCorner(r0, a0) + pathCorner(r1, a0);\n        }\n        applyZoomMove(path1, cpath);\n    }\n\n    function findPolygonRadius(x, y, va0, va1) {\n        var xy = helpers.findIntersectionXY(va0, va1, va0, [x - cxx, cyy - y]);\n        return norm(xy[0], xy[1]);\n    }\n\n    function zoomMoveForPolygons(dx, dy) {\n        var x1 = x0 + dx;\n        var y1 = y0 + dy;\n        var a0 = xy2a(x0, y0);\n        var a1 = xy2a(x1, y1);\n        var vangles0 = findEnclosingVertexAngles(a0, vangles);\n        var vangles1 = findEnclosingVertexAngles(a1, vangles);\n        var rr0 = findPolygonRadius(x0, y0, vangles0[0], vangles0[1]);\n        var rr1 = Math.min(findPolygonRadius(x1, y1, vangles1[0], vangles1[1]), radius);\n        var path1;\n        var cpath;\n\n        if(clampAndSetR0R1(rr0, rr1)) {\n            path1 = path0 + _this.pathSector(r1);\n            if(r0) path1 += _this.pathSector(r0);\n            // keep 'starting' angle here too\n            cpath = [\n                pathCornerForPolygons(r0, vangles0[0], vangles0[1]),\n                pathCornerForPolygons(r1, vangles0[0], vangles0[1])\n            ].join(' ');\n        }\n        applyZoomMove(path1, cpath);\n    }\n\n    function zoomDone() {\n        dragBox.removeZoombox(gd);\n\n        if(r0 === null || r1 === null) return;\n        var updateObj = {};\n        computeZoomUpdates(updateObj);\n\n        dragBox.showDoubleClickNotifier(gd);\n\n        Registry.call('_guiRelayout', gd, updateObj);\n    }\n\n    function computeZoomUpdates(update) {\n        var rl = radialAxis._rl;\n        var m = (rl[1] - rl[0]) / (1 - innerRadius / radius) / radius;\n        var newRng = [\n            rl[0] + (r0 - innerRadius) * m,\n            rl[0] + (r1 - innerRadius) * m\n        ];\n        update[_this.id + '.radialaxis.range'] = newRng;\n    }\n\n    function zoomClick(numClicks, evt) {\n        var clickMode = gd._fullLayout.clickmode;\n\n        dragBox.removeZoombox(gd);\n\n        // TODO double once vs twice logic (autorange vs fixed range)\n        if(numClicks === 2) {\n            var updateObj = {};\n            for(var k in _this.viewInitial) {\n                updateObj[_this.id + '.' + k] = _this.viewInitial[k];\n            }\n\n            gd.emit('plotly_doubleclick', null);\n            Registry.call('_guiRelayout', gd, updateObj);\n        }\n\n        if(clickMode.indexOf('select') > -1 && numClicks === 1) {\n            selectOnClick(evt, gd, [_this.xaxis], [_this.yaxis], _this.id, dragOpts);\n        }\n\n        if(clickMode.indexOf('event') > -1) {\n            Fx.click(gd, evt, _this.id);\n        }\n    }\n\n    dragOpts.prepFn = function(evt, startX, startY) {\n        var dragModeNow = gd._fullLayout.dragmode;\n\n        var bbox = mainDrag.getBoundingClientRect();\n        x0 = startX - bbox.left;\n        y0 = startY - bbox.top;\n\n        // need to offset x/y as bbox center does not\n        // match origin for asymmetric polygons\n        if(vangles) {\n            var offset = helpers.findPolygonOffset(radius, sectorInRad[0], sectorInRad[1], vangles);\n            x0 += cxx + offset[0];\n            y0 += cyy + offset[1];\n        }\n\n        switch(dragModeNow) {\n            case 'zoom':\n                if(vangles) {\n                    dragOpts.moveFn = zoomMoveForPolygons;\n                } else {\n                    dragOpts.moveFn = zoomMove;\n                }\n                dragOpts.clickFn = zoomClick;\n                dragOpts.doneFn = zoomDone;\n                zoomPrep(evt, startX, startY);\n                break;\n            case 'select':\n            case 'lasso':\n                prepSelect(evt, startX, startY, dragOpts, dragModeNow);\n                break;\n        }\n    };\n\n    mainDrag.onmousemove = function(evt) {\n        Fx.hover(gd, evt, _this.id);\n        gd._fullLayout._lasthover = mainDrag;\n        gd._fullLayout._hoversubplot = _this.id;\n    };\n\n    mainDrag.onmouseout = function(evt) {\n        if(gd._dragging) return;\n        dragElement.unhover(gd, evt);\n    };\n\n    dragElement.init(dragOpts);\n};\n\nproto.updateRadialDrag = function(fullLayout, polarLayout, rngIndex) {\n    var _this = this;\n    var gd = _this.gd;\n    var layers = _this.layers;\n    var radius = _this.radius;\n    var innerRadius = _this.innerRadius;\n    var cx = _this.cx;\n    var cy = _this.cy;\n    var radialAxis = _this.radialAxis;\n    var bl = constants.radialDragBoxSize;\n    var bl2 = bl / 2;\n\n    if(!radialAxis.visible) return;\n\n    var angle0 = deg2rad(_this.radialAxisAngle);\n    var rl = radialAxis._rl;\n    var rl0 = rl[0];\n    var rl1 = rl[1];\n    var rbase = rl[rngIndex];\n    var m = 0.75 * (rl[1] - rl[0]) / (1 - polarLayout.hole) / radius;\n\n    var tx, ty, className;\n    if(rngIndex) {\n        tx = cx + (radius + bl2) * Math.cos(angle0);\n        ty = cy - (radius + bl2) * Math.sin(angle0);\n        className = 'radialdrag';\n    } else {\n        // the 'inner' box can get called:\n        // - when polar.hole>0\n        // - when polar.sector isn't a full circle\n        // otherwise it is hidden behind the main drag.\n        tx = cx + (innerRadius - bl2) * Math.cos(angle0);\n        ty = cy - (innerRadius - bl2) * Math.sin(angle0);\n        className = 'radialdrag-inner';\n    }\n\n    var radialDrag = dragBox.makeRectDragger(layers, className, 'crosshair', -bl2, -bl2, bl, bl);\n    var dragOpts = {element: radialDrag, gd: gd};\n\n    updateElement(d3.select(radialDrag), radialAxis.visible && innerRadius < radius, {\n        transform: strTranslate(tx, ty)\n    });\n\n    // move function (either rotate or re-range flavor)\n    var moveFn2;\n    // rotate angle on done\n    var angle1;\n    // re-range range[1] (or range[0]) on done\n    var rprime;\n\n    function moveFn(dx, dy) {\n        if(moveFn2) {\n            moveFn2(dx, dy);\n        } else {\n            var dvec = [dx, -dy];\n            var rvec = [Math.cos(angle0), Math.sin(angle0)];\n            var comp = Math.abs(Lib.dot(dvec, rvec) / Math.sqrt(Lib.dot(dvec, dvec)));\n\n            // mostly perpendicular motions rotate,\n            // mostly parallel motions re-range\n            if(!isNaN(comp)) {\n                moveFn2 = comp < 0.5 ? rotateMove : rerangeMove;\n            }\n        }\n\n        var update = {};\n        computeRadialAxisUpdates(update);\n        gd.emit('plotly_relayouting', update);\n    }\n\n    function computeRadialAxisUpdates(update) {\n        if(angle1 !== null) {\n            update[_this.id + '.radialaxis.angle'] = angle1;\n        } else if(rprime !== null) {\n            update[_this.id + '.radialaxis.range[' + rngIndex + ']'] = rprime;\n        }\n    }\n\n    function doneFn() {\n        if(angle1 !== null) {\n            Registry.call('_guiRelayout', gd, _this.id + '.radialaxis.angle', angle1);\n        } else if(rprime !== null) {\n            Registry.call('_guiRelayout', gd, _this.id + '.radialaxis.range[' + rngIndex + ']', rprime);\n        }\n    }\n\n    function rotateMove(dx, dy) {\n        // disable for inner drag boxes\n        if(rngIndex === 0) return;\n\n        var x1 = tx + dx;\n        var y1 = ty + dy;\n\n        angle1 = Math.atan2(cy - y1, x1 - cx);\n        if(_this.vangles) angle1 = snapToVertexAngle(angle1, _this.vangles);\n        angle1 = rad2deg(angle1);\n\n        var transform = strTranslate(cx, cy) + strRotate(-angle1);\n        layers['radial-axis'].attr('transform', transform);\n        layers['radial-line'].select('line').attr('transform', transform);\n\n        var fullLayoutNow = _this.gd._fullLayout;\n        var polarLayoutNow = fullLayoutNow[_this.id];\n        _this.updateRadialAxisTitle(fullLayoutNow, polarLayoutNow, angle1);\n    }\n\n    function rerangeMove(dx, dy) {\n        // project (dx, dy) unto unit radial axis vector\n        var dr = Lib.dot([dx, -dy], [Math.cos(angle0), Math.sin(angle0)]);\n        rprime = rbase - m * dr;\n\n        // make sure rprime does not change the range[0] -> range[1] sign\n        if((m > 0) !== (rngIndex ? rprime > rl0 : rprime < rl1)) {\n            rprime = null;\n            return;\n        }\n\n        var fullLayoutNow = gd._fullLayout;\n        var polarLayoutNow = fullLayoutNow[_this.id];\n\n        // update radial range -> update c2g -> update _m,_b\n        radialAxis.range[rngIndex] = rprime;\n        radialAxis._rl[rngIndex] = rprime;\n        _this.updateRadialAxis(fullLayoutNow, polarLayoutNow);\n\n        _this.xaxis.setRange();\n        _this.xaxis.setScale();\n        _this.yaxis.setRange();\n        _this.yaxis.setScale();\n\n        var hasRegl = false;\n\n        for(var traceType in _this.traceHash) {\n            var moduleCalcData = _this.traceHash[traceType];\n            var moduleCalcDataVisible = Lib.filterVisible(moduleCalcData);\n            var _module = moduleCalcData[0][0].trace._module;\n            _module.plot(gd, _this, moduleCalcDataVisible, polarLayoutNow);\n            if(Registry.traceIs(traceType, 'gl') && moduleCalcDataVisible.length) hasRegl = true;\n        }\n\n        if(hasRegl) {\n            clearGlCanvases(gd);\n            redrawReglTraces(gd);\n        }\n    }\n\n    dragOpts.prepFn = function() {\n        moveFn2 = null;\n        angle1 = null;\n        rprime = null;\n\n        dragOpts.moveFn = moveFn;\n        dragOpts.doneFn = doneFn;\n\n        clearSelect(gd);\n    };\n\n    dragOpts.clampFn = function(dx, dy) {\n        if(Math.sqrt(dx * dx + dy * dy) < constants.MINDRAG) {\n            dx = 0;\n            dy = 0;\n        }\n        return [dx, dy];\n    };\n\n    dragElement.init(dragOpts);\n};\n\nproto.updateAngularDrag = function(fullLayout) {\n    var _this = this;\n    var gd = _this.gd;\n    var layers = _this.layers;\n    var radius = _this.radius;\n    var angularAxis = _this.angularAxis;\n    var cx = _this.cx;\n    var cy = _this.cy;\n    var cxx = _this.cxx;\n    var cyy = _this.cyy;\n    var dbs = constants.angularDragBoxSize;\n\n    var angularDrag = dragBox.makeDragger(layers, 'path', 'angulardrag', 'move');\n    var dragOpts = {element: angularDrag, gd: gd};\n\n    d3.select(angularDrag)\n        .attr('d', _this.pathAnnulus(radius, radius + dbs))\n        .attr('transform', strTranslate(cx, cy))\n        .call(setCursor, 'move');\n\n    function xy2a(x, y) {\n        return Math.atan2(cyy + dbs - y, x - cxx - dbs);\n    }\n\n    // scatter trace, points and textpoints selections\n    var scatterTraces = layers.frontplot.select('.scatterlayer').selectAll('.trace');\n    var scatterPoints = scatterTraces.selectAll('.point');\n    var scatterTextPoints = scatterTraces.selectAll('.textpoint');\n\n    // mouse px position at drag start (0), move (1)\n    var x0, y0;\n    // angular axis angle rotation at drag start (0), move (1)\n    var rot0, rot1;\n    // induced radial axis rotation (only used on polygon grids)\n    var rrot1;\n    // angle about circle center at drag start\n    var a0;\n\n    function moveFn(dx, dy) {\n        var fullLayoutNow = _this.gd._fullLayout;\n        var polarLayoutNow = fullLayoutNow[_this.id];\n\n        var x1 = x0 + dx;\n        var y1 = y0 + dy;\n        var a1 = xy2a(x1, y1);\n        var da = rad2deg(a1 - a0);\n        rot1 = rot0 + da;\n\n        layers.frontplot.attr('transform',\n            strTranslate(_this.xOffset2, _this.yOffset2) + strRotate([-da, cxx, cyy])\n        );\n\n        if(_this.vangles) {\n            rrot1 = _this.radialAxisAngle + da;\n\n            var trans = strTranslate(cx, cy) + strRotate(-da);\n            var trans2 = strTranslate(cx, cy) + strRotate(-rrot1);\n\n            layers.bg.attr('transform', trans);\n            layers['radial-grid'].attr('transform', trans);\n            layers['radial-axis'].attr('transform', trans2);\n            layers['radial-line'].select('line').attr('transform', trans2);\n            _this.updateRadialAxisTitle(fullLayoutNow, polarLayoutNow, rrot1);\n        } else {\n            _this.clipPaths.forTraces.select('path').attr('transform',\n                strTranslate(cxx, cyy) + strRotate(da)\n            );\n        }\n\n        // 'un-rotate' marker and text points\n        scatterPoints.each(function() {\n            var sel = d3.select(this);\n            var xy = Drawing.getTranslate(sel);\n            sel.attr('transform', strTranslate(xy.x, xy.y) + strRotate([da]));\n        });\n        scatterTextPoints.each(function() {\n            var sel = d3.select(this);\n            var tx = sel.select('text');\n            var xy = Drawing.getTranslate(sel);\n            // N.B rotate -> translate ordering matters\n            sel.attr('transform', strRotate([da, tx.attr('x'), tx.attr('y')]) + strTranslate(xy.x, xy.y));\n        });\n\n        // update rotation -> range -> _m,_b\n        angularAxis.rotation = Lib.modHalf(rot1, 360);\n        _this.updateAngularAxis(fullLayoutNow, polarLayoutNow);\n\n        if(_this._hasClipOnAxisFalse && !Lib.isFullCircle(_this.sectorInRad)) {\n            scatterTraces.call(Drawing.hideOutsideRangePoints, _this);\n        }\n\n        var hasRegl = false;\n\n        for(var traceType in _this.traceHash) {\n            if(Registry.traceIs(traceType, 'gl')) {\n                var moduleCalcData = _this.traceHash[traceType];\n                var moduleCalcDataVisible = Lib.filterVisible(moduleCalcData);\n                var _module = moduleCalcData[0][0].trace._module;\n                _module.plot(gd, _this, moduleCalcDataVisible, polarLayoutNow);\n                if(moduleCalcDataVisible.length) hasRegl = true;\n            }\n        }\n\n        if(hasRegl) {\n            clearGlCanvases(gd);\n            redrawReglTraces(gd);\n        }\n\n        var update = {};\n        computeRotationUpdates(update);\n        gd.emit('plotly_relayouting', update);\n    }\n\n    function computeRotationUpdates(updateObj) {\n        updateObj[_this.id + '.angularaxis.rotation'] = rot1;\n\n        if(_this.vangles) {\n            updateObj[_this.id + '.radialaxis.angle'] = rrot1;\n        }\n    }\n\n    function doneFn() {\n        scatterTextPoints.select('text').attr('transform', null);\n\n        var updateObj = {};\n        computeRotationUpdates(updateObj);\n        Registry.call('_guiRelayout', gd, updateObj);\n    }\n\n    dragOpts.prepFn = function(evt, startX, startY) {\n        var polarLayoutNow = fullLayout[_this.id];\n        rot0 = polarLayoutNow.angularaxis.rotation;\n\n        var bbox = angularDrag.getBoundingClientRect();\n        x0 = startX - bbox.left;\n        y0 = startY - bbox.top;\n        a0 = xy2a(x0, y0);\n\n        dragOpts.moveFn = moveFn;\n        dragOpts.doneFn = doneFn;\n\n        clearSelect(gd);\n    };\n\n    // I don't what we should do in this case, skip we now\n    if(_this.vangles && !Lib.isFullCircle(_this.sectorInRad)) {\n        dragOpts.prepFn = Lib.noop;\n        setCursor(d3.select(angularDrag), null);\n    }\n\n    dragElement.init(dragOpts);\n};\n\nproto.isPtInside = function(d) {\n    var sectorInRad = this.sectorInRad;\n    var vangles = this.vangles;\n    var thetag = this.angularAxis.c2g(d.theta);\n    var radialAxis = this.radialAxis;\n    var r = radialAxis.c2l(d.r);\n    var rl = radialAxis._rl;\n\n    var fn = vangles ? helpers.isPtInsidePolygon : Lib.isPtInsideSector;\n    return fn(r, thetag, rl, sectorInRad, vangles);\n};\n\nproto.pathArc = function(r) {\n    var sectorInRad = this.sectorInRad;\n    var vangles = this.vangles;\n    var fn = vangles ? helpers.pathPolygon : Lib.pathArc;\n    return fn(r, sectorInRad[0], sectorInRad[1], vangles);\n};\n\nproto.pathSector = function(r) {\n    var sectorInRad = this.sectorInRad;\n    var vangles = this.vangles;\n    var fn = vangles ? helpers.pathPolygon : Lib.pathSector;\n    return fn(r, sectorInRad[0], sectorInRad[1], vangles);\n};\n\nproto.pathAnnulus = function(r0, r1) {\n    var sectorInRad = this.sectorInRad;\n    var vangles = this.vangles;\n    var fn = vangles ? helpers.pathPolygonAnnulus : Lib.pathAnnulus;\n    return fn(r0, r1, sectorInRad[0], sectorInRad[1], vangles);\n};\n\nproto.pathSubplot = function() {\n    var r0 = this.innerRadius;\n    var r1 = this.radius;\n    return r0 ? this.pathAnnulus(r0, r1) : this.pathSector(r1);\n};\n\nproto.fillViewInitialKey = function(key, val) {\n    if(!(key in this.viewInitial)) {\n        this.viewInitial[key] = val;\n    }\n};\n\nfunction strTickLayout(axLayout) {\n    var out = axLayout.ticks + String(axLayout.ticklen) + String(axLayout.showticklabels);\n    if('side' in axLayout) out += axLayout.side;\n    return out;\n}\n\n// Finds the bounding box of a given circle sector,\n// inspired by https://math.stackexchange.com/q/1852703\n//\n// assumes:\n// - sector[0] < sector[1]\n// - counterclockwise rotation\nfunction computeSectorBBox(sector) {\n    var s0 = sector[0];\n    var s1 = sector[1];\n    var arc = s1 - s0;\n    var a0 = mod(s0, 360);\n    var a1 = a0 + arc;\n\n    var ax0 = Math.cos(deg2rad(a0));\n    var ay0 = Math.sin(deg2rad(a0));\n    var ax1 = Math.cos(deg2rad(a1));\n    var ay1 = Math.sin(deg2rad(a1));\n\n    var x0, y0, x1, y1;\n\n    if((a0 <= 90 && a1 >= 90) || (a0 > 90 && a1 >= 450)) {\n        y1 = 1;\n    } else if(ay0 <= 0 && ay1 <= 0) {\n        y1 = 0;\n    } else {\n        y1 = Math.max(ay0, ay1);\n    }\n\n    if((a0 <= 180 && a1 >= 180) || (a0 > 180 && a1 >= 540)) {\n        x0 = -1;\n    } else if(ax0 >= 0 && ax1 >= 0) {\n        x0 = 0;\n    } else {\n        x0 = Math.min(ax0, ax1);\n    }\n\n    if((a0 <= 270 && a1 >= 270) || (a0 > 270 && a1 >= 630)) {\n        y0 = -1;\n    } else if(ay0 >= 0 && ay1 >= 0) {\n        y0 = 0;\n    } else {\n        y0 = Math.min(ay0, ay1);\n    }\n\n    if(a1 >= 360) {\n        x1 = 1;\n    } else if(ax0 <= 0 && ax1 <= 0) {\n        x1 = 0;\n    } else {\n        x1 = Math.max(ax0, ax1);\n    }\n\n    return [x0, y0, x1, y1];\n}\n\nfunction snapToVertexAngle(a, vangles) {\n    var fn = function(v) { return Lib.angleDist(a, v); };\n    var ind = Lib.findIndexOfMin(vangles, fn);\n    return vangles[ind];\n}\n\nfunction updateElement(sel, showAttr, attrs) {\n    if(showAttr) {\n        sel.attr('display', null);\n        sel.attr(attrs);\n    } else if(sel) {\n        sel.attr('display', 'none');\n    }\n    return sel;\n}\n\nfunction strTranslate(x, y) {\n    return 'translate(' + x + ',' + y + ')';\n}\n\nfunction strRotate(angle) {\n    return 'rotate(' + angle + ')';\n}\n"]},"metadata":{},"sourceType":"script"}